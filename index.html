<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»æƒ³å†’éšª - ç¨®æ—æ“´å……ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #ff9800;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Rarity Colors */
            --common: #b0b0b0;
            --uncommon: #4caf50;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ffd700;
            --mythic: #ff0055;
            --ultra: #00ffcc;
            /* Buff Colors */
            --buff-angel: #4fc3f7;
            --buff-demon: #ef5350;
        } 

/* --- æ–°å¢æ¨£å¼ï¼šæˆ°é¬¥æç¤ºæ–‡å­— --- */
.combat-hint {
    position: absolute;  /* çµ•å°å®šä½ */
    bottom: 10px;        /* å›ºå®šåœ¨çˆ¶å®¹å™¨åº•éƒ¨ 10px çš„ä½ç½® */
    left: 0;
    width: 100%;         /* å¯¬åº¦ä½”æ»¿ */
    text-align: center;  /* æ–‡å­—ç½®ä¸­ */
    font-size: 0.8em;
    color: #666;         /* é¡è‰²ç¨å¾®æ·±ä¸€é»ï¼Œä¸è¦å¤ªæ¶çœ¼ */
    pointer-events: none; /* è®“é»æ“Šç©¿é€ï¼Œé¿å…æ“‹åˆ°å…¶ä»–æ“ä½œ (é›–ç„¶åœ¨åº•éƒ¨æ‡‰è©²ä¸æœƒ) */
}

/* --- æ–°å¢æ¨£å¼ï¼šæŠ€èƒ½èˆ‡ MP --- */
.mp-text { color: #2196f3; font-weight: bold; }
.skill-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 150px;
    overflow-y: auto;
    margin-top: 5px;
    
    box-sizing: border-box;
    width: 100%; 
    max-width: 100%; 
    
    /* [ä¿®æ”¹] æ”¹ç‚º 0ï¼Œè®“æŒ‰éˆ•å¯¬åº¦èˆ‡ä¸Šæ–¹æ–‡å­—å°é½Š */
    padding: 0; 
}
/* --- [è£œä¸Š] å¼·åˆ¶å›ºå®šæ²è»¸æ¨£å¼ï¼Œé¿å…æ²è»¸å‡ºç¾æ™‚æ“ å£“å…§å®¹ --- */
.skill-list::-webkit-scrollbar {
    width: 8px; /* é–å®šæ²è»¸å¯¬åº¦ */
}
.skill-list::-webkit-scrollbar-track {
    background: #222; 
    border-radius: 4px;
}
.skill-list::-webkit-scrollbar-thumb {
    background: #555; 
    border-radius: 4px;
}
.skill-item { 
    background: #333;
    border: 2px solid transparent; 
    border-color: #555; 
    
    padding: 10px; 
    border-radius: 4px;
    cursor: pointer; 
    display: flex;
    justify-content: space-between; 
    align-items: center;
    
    box-sizing: border-box;
    flex-shrink: 0;
    
    /* [é—œéµ] å¼·åˆ¶è¨­ç‚º 100%ï¼Œä½†å—é™æ–¼çˆ¶å®¹å™¨çš„ max-widthï¼Œæ‰€ä»¥ä¸æœƒç„¡é™è®Šå¯¬ */
    width: 100%; 
    
    height: 60px;
    overflow: hidden;
}
.skill-item:hover { background: #444; border-color: var(--accent-color); }
.skill-item.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
.skill-cost { color: #64b5f6; font-size: 0.9em; }
.skill-desc-box { 
    font-size: 0.8em; 
    color: #aaa; 
    margin-top: 4px;
    
    /* [æ–°å¢] ä»¥ä¸‹ä¸‰è¡Œæ˜¯ç”¨ä¾†å¼·åˆ¶æ–‡å­—ä¸æ›è¡Œï¼Œè¶…å‡ºé¡¯ç¤º ... */
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
    
    /* ç¢ºä¿å®ƒä¸æœƒæ’é–‹å¯¬åº¦ */
    width: 100%; 
}
/* [æ–°å¢] ç¢ºä¿æŠ€èƒ½æŒ‰éˆ•å…§çš„æ–‡å­—å®¹å™¨ä¸æœƒè¶…éæŒ‰éˆ•å¯¬åº¦ */
.skill-item > div {
    overflow: hidden; /* è¶…å‡ºé‚Šç•Œéš±è— */
    width: 100%;      /* ä½”æ»¿ç©ºé–“ */
}

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--panel-color);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        /* Header & Stats */
        header {
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .badge-group { display: flex; gap: 5px; }
        .class-badge {
            font-size: 0.8em;
            background: #444;
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-color);
        }
        .race-badge {
            font-size: 0.8em;
            background: #2c3e50;
            padding: 2px 8px;
            border-radius: 4px;
            color: #3498db;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
        }

        .stat-item span { font-weight: bold; color: var(--accent-color); }
        
        #buff-display {
            grid-column: span 2;
            border-top: 1px solid #444;
            padding-top: 5px;
            margin-top: 5px;
            font-size: 0.85em;
            color: #aaa;
            cursor: help;
            transition: 0.2s;
        }
        #buff-display:hover { background: #333; }

        /* Main Event Area */
        #event-display {
            min-height: 200px;
            background: #222;
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
        }

    #event-desc {
    /* [é—œéµ] å¼·åˆ¶ä½”æ»¿çˆ¶å®¹å™¨çš„å¯¬åº¦ï¼Œä¸å†éš¨æ–‡å­—å…§å®¹ç¸®æ”¾ */
    width: 100%; 
    
    /* ä¿æŒåŸæœ¬çš„è¨­å®š */
    max-width: 100%;
    box-sizing: border-box;
}

        .monster-icon { font-size: 4em; margin-bottom: 10px; display: inline-block; transition: 0.3s; }
        
        /* Glow Effects */
        .glow-blue { filter: drop-shadow(0 0 10px #2196f3); }
        .glow-red { filter: drop-shadow(0 0 15px #f44336); transform: scale(1.1); }
        .glow-purple { filter: drop-shadow(0 0 20px #9c27b0); animation: true-form-pulse 2s infinite; transform: scale(1.3); }

        @keyframes true-form-pulse {
            0% { filter: drop-shadow(0 0 20px #9c27b0); }
            50% { filter: drop-shadow(0 0 40px #e040fb); }
            100% { filter: drop-shadow(0 0 20px #9c27b0); }
        }

        /* Animations */
        @keyframes spawn-pop { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes damage-shake { 0% { transform: translate(0, 0); filter: none; } 20% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translate(10px, 0) rotate(5deg); } 60% { transform: translate(-5px, 0); } 80% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        @keyframes attack-lunge { 0% { transform: translateY(0) scale(1); } 30% { transform: translateY(20px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
        @keyframes screen-shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, -5px); } 100% { transform: translate(0, 0); } }
        @keyframes float-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.2); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }

        .anim-spawn { animation: spawn-pop 0.5s ease-out forwards; }
        .anim-damage { animation: damage-shake 0.4s ease-in-out; }
        .anim-lunge { animation: attack-lunge 0.3s ease-in-out; }
        .anim-screen-shake { animation: screen-shake 0.3s ease-in-out; }

        .floating-text {
            position: absolute;
            left: 50%; /* ä¿æŒæ°´å¹³å±…ä¸­ */
            /* ç§»é™¤ top: 40% æˆ– 50% çš„å›ºå®šè¨­ç½® */
            transform: translateX(-50%);
            font-weight: bold; font-size: 1.5em; pointer-events: none;
            text-shadow: 2px 2px 0 #000; z-index: 100;
        }
/* --- è£œä¸Šéºå¤±çš„æµ®å‹•å‹•ç•« --- */
@keyframes float-up-base { 
    0% { transform: translate(-50%, 0); opacity: 1; } 
    100% { transform: translate(-50%, -60px); opacity: 0; }
}

/* ç¢ºä¿é€™å…©å€‹é¡åˆ¥æœ‰å¼•ç”¨å‹•ç•« */
.floating-text.dmg-out { 
    left: 35%;
    top: 55%;
    animation: float-up-base 1s ease-out forwards; /* é€™è£¡å¼•ç”¨ä¸Šé¢çš„ keyframes */
}

.floating-text.dmg-in { 
    left: 65%;
    top: 45%;
    animation: float-up-base 1s ease-out forwards; /* é€™è£¡å¼•ç”¨ä¸Šé¢çš„ keyframes */
}

        /* æ–°å¢ä¸€å€‹å¹³ç§»çš„åŸºç¤å‹•ç•« */
        @keyframes float-up-base { 
            0% { transform: translate(-50%, 0); opacity: 1; } 
            100% { transform: translate(-50%, -60px); opacity: 0; }
        }
        .anim-float { animation: float-up-base 1s ease-out forwards; }
        
        /* é‡å°ä¸åŒé¡å‹çš„æµ®å‹•æ–‡å­—ï¼Œè¨­ç½®ä¸åŒçš„èµ·å§‹æ°´å¹³å’Œå‚ç›´åç§» */
        .floating-text.dmg-out { 
            left: 35%; /* ç©å®¶å‚·å®³/æ²»ç™‚ï¼šåå·¦ */
            top: 55%;  /* å‚ç›´èµ·å§‹é»è¨­ç½®è¼ƒä½ */
            animation: float-up-base 1s ease-out forwards; 
        }
        .floating-text.dmg-in { 
            left: 65%; /* æ€ªç‰©å‚·å®³ï¼šåå³ */
            top: 45%;  /* å‚ç›´èµ·å§‹é»è¨­ç½®è¼ƒé«˜ */
            animation: float-up-base 1s ease-out forwards;
        }
        

        /* Text Styles */
        .damage-text { color: #ff5252; font-weight: bold; }
        .crit-text { color: #ff0000; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 5px #fff; }
        .heal-text { color: #69f0ae; }
        .gold-text { color: #ffd700; }
        .block-text { color: #2196f3; font-weight: bold; }
        .pierce-text { color: #ff9800; font-weight: bold; }
        .angel-text { color: var(--buff-angel); font-weight: bold; }
        .demon-text { color: var(--buff-demon); font-weight: bold; }
        .mythic-text { color: var(--mythic); font-weight: bold; text-shadow: 0 0 5px #fff; }

        /* Controls */
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.2s; background: #444; color: white; }
        button:hover { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent-color); color: #000; }
        .btn-primary:hover { background: #ffb74d; }
        
        /* Inventory */
        #inventory-section { background: #222; padding: 10px; border-radius: var(--border-radius); }
        .equipment-slots { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .equip-slot { flex: 1; background: #333; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.75em; min-height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; }
        
        .inv-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .inv-col h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #888; text-align: center; border-bottom: 1px solid #444; padding-bottom: 3px; }
        .item-list { display: flex; flex-direction: column; gap: 4px; max-height: 200px; overflow-y: auto; min-height: 50px; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        
        .item { padding: 4px 8px; background: #333; border-radius: 3px; font-size: 0.8em; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .item:hover { background: #444; }

        /* Rarity */
        .rarity-common { color: var(--common); border-color: #555; }
        .rarity-uncommon { color: var(--uncommon); border-color: var(--uncommon); }
        .rarity-rare { color: var(--rare); border-color: var(--rare); }
        .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); }
        .rarity-legendary { color: var(--legendary); border-color: var(--legendary); box-shadow: 0 0 8px var(--legendary); background: linear-gradient(45deg, #333, #443300); animation: shine 2s infinite linear; }
        .rarity-mythic { color: var(--mythic); border-color: var(--mythic); box-shadow: 0 0 15px var(--mythic); background: #220011; animation: shine 1s infinite linear; }
        .rarity-ultra { color: var(--ultra); border-color: var(--ultra); box-shadow: 0 0 20px var(--ultra); background: #001122; animation: shine 0.5s infinite linear; }
        
        @keyframes shine { 0% { border-color: var(--legendary); } 50% { border-color: #fff; } 100% { border-color: var(--legendary); } }

        /* MERCHANT GRID FIX: 3 cols for 12 items */
        .merchant-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-height: 300px; overflow-y: auto; padding-right: 5px; }
        .merchant-item { display: flex; flex-direction: column; background: #333; padding: 10px; border-radius: 4px; cursor: pointer; border: 1px solid #444; min-height: 70px;}
        .merchant-item:hover { background: #444; }
        .m-top { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9em; }
        .m-desc { font-size: 0.75em; color: #aaa; margin-top: 4px; }

        /* Modals */
        #race-modal, #class-modal, #achieve-modal, #compendium-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #race-modal { display: none; } /* Default state should be hidden, controlled by JS */
        #class-modal { display: none; }

        .class-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; padding: 20px; }
        .class-card { background: #333; padding: 20px; border-radius: 8px; cursor: pointer; border: 2px solid #555; text-align: center; transition: 0.2s; }
        .class-card:hover { border-color: var(--accent-color); background: #444; transform: translateY(-5px); }
        .class-title { font-size: 1.2em; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
        .class-desc { font-size: 0.9em; color: #ccc; }

        /* Achievements & Compendium */
        .achieve-list, .compendium-container { max-height: 70vh; overflow-y: auto; width: 90%; max-width: 600px; background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .achieve-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; opacity: 0.5; }
        .achieve-item.unlocked { opacity: 1; background: #2a2a2a; }
        .achieve-info { display: flex; flex-direction: column; }
        .achieve-name { font-weight: bold; font-size: 1.1em; }
        .achieve-cond { font-size: 0.8em; color: #aaa; }
        .achieve-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }

        .compendium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding-top: 10px; }
        .c-item { 
            background: #333; border: 1px solid #444; border-radius: 4px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; cursor: help; min-height: 80px; position: relative;
        }
        .c-item.unlocked { background: #2d2d2d; }
        .c-item.unknown { background: #222; border-color: #333; opacity: 0.7; filter: grayscale(100%); }
        .c-item.secret-hidden { background: #000; border-color: #000; cursor: default; }
        
        .c-icon { font-size: 2em; margin-bottom: 5px; }
        .c-name { font-size: 0.75em; line-height: 1.2; word-break: break-all; }
        .c-item.unknown .c-name { color: #666; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="race-modal">
    <h2 style="color:white; margin-bottom: 30px;">é¸æ“‡ä½ çš„ç¨®æ—</h2>
    <div class="class-options">
        <div class="class-card" onclick="Game.selectRace('elf')">
            <div class="class-title">ğŸ§ ç²¾éˆ</div>
            <div class="class-desc">é€²å…¥æˆ°é¬¥æ¯å›åˆèˆ‡é‡åˆ°äº‹ä»¶å¾Œ<br>å›å¾© 5% ç”Ÿå‘½</div>
        </div>
        <div class="class-card" onclick="Game.selectRace('demon')">
            <div class="class-title">ğŸ‘¿ é­”æ—</div>
            <div class="class-desc">ç”Ÿå‘½å·å–<br>é€ æˆå‚·å®³çš„ 15% è½‰ç‚ºç”Ÿå‘½</div>
        </div>
        <div class="class-card" onclick="Game.selectRace('human')">
            <div class="class-title">ğŸ‘± äººé¡</div>
            <div class="class-desc">å¤©è³¦ç•°ç¨Ÿ<br>æš´æ“Šç‡ +25%</div>
        </div>
        <div class="class-card" onclick="Game.selectRace('orc')">
            <div class="class-title">ğŸ‘¹ åŠç¸äºº</div>
            <div class="class-desc">å …ç¡¬çš®è†š<br>å—åˆ°çš„å‚·å®³æ¸›å°‘ 20%</div>
        </div>
    </div>
</div>
<div id="gender-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; flex-direction:column; align-items:center; justify-content:center;">
    <h2 style="color:white; margin-bottom: 30px;">ç”Ÿç†/å¿ƒç†æ€§åˆ¥?</h2>
    <div class="class-options">
        <div class="class-card" onclick="Game.selectGender('male')">
            <div class="class-title">ğŸš¹ ç”·æ€§</div>
            <div class="class-desc">å¹³å‡¡ç„¡å¥‡<br>åŸºç¤æ”»æ“Š +10</div>
        </div>
        <div class="class-card" onclick="Game.selectGender('female')">
            <div class="class-title">ğŸšº å¥³æ€§</div>
            <div class="class-desc">éª¨éª¼é©šå¥‡<br>ç”Ÿå‘½ä¸Šé™ +40</div>
        </div>
        <div class="class-card" onclick="Game.selectGender('none')">
            <div class="class-title">ğŸ—¿ ç„¡æ€§åˆ¥</div>
            <div class="class-desc">å¿ƒå¦‚æ­¢æ°´<br>é˜²ç¦¦æ•ˆæœ +10% (æ¸›å‚·)</div>
        </div>
        <div class="class-card" onclick="Game.selectGender('nonbinary')">
            <div class="class-title">ğŸŒˆ éäºŒå…ƒ</div>
            <div class="class-desc">ç„¡æ³•è¢«å®šç¾©<br>æ¯å›åˆéš¨æ©Ÿç²å¾— 1~10 é‡‘å¹£</div>
        </div>
    </div>
</div>

<div id="orientation-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; flex-direction:column; align-items:center; justify-content:center;">
    <h2 style="color:white; margin-bottom: 30px;">ä½ çš„æˆ€æ„›å–å‘?</h2>
    <div class="class-options">
        <div class="class-card" onclick="Game.selectOrientation('hetero')">
            <div class="class-title">ğŸ‘« ç•°æ€§æˆ€</div>
            <div class="class-desc">ä¸çŸ¥é“è¦å¯«å•¥<br>æš´æ“Šå‚·å®³ +20%</div>
        </div>
        <div class="class-card" onclick="Game.selectOrientation('homo')">
            <div class="class-title">ğŸ‘¬/ğŸ‘­ åŒæ€§æˆ€</div>
            <div class="class-desc">ç‰›é ­<br>å•†åº—åƒ¹æ ¼æ‰“ 9 æŠ˜</div>
        </div>
    </div>
</div>

<div id="class-modal">
    <h2 style="color:white; margin-bottom: 30px;">é¸æ“‡ä½ çš„è·æ¥­</h2>
    <div class="class-options">
        <div class="class-card" onclick="Game.selectClass('knight')">
            <div class="class-title">ğŸ›¡ï¸ é¨å£«</div>
            <div class="class-desc">é–‹å±€è£å‚™<br>ã€Œé¨å£«é•·æ§ã€</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('merchant')">
            <div class="class-title">ğŸ’° å•†è²©</div>
            <div class="class-desc">å‡ºå”®ç‰©å“åƒ¹æ ¼<br>æå‡ç‚º 1.2 å€</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('thief')">
            <div class="class-title">ğŸ—¡ï¸ ç›œè³Š</div>
            <div class="class-desc">é–‹å•Ÿå¯¶ç®±æ™‚<br>ä¸æœƒé‡åˆ°é™·é˜±æˆ–ç©ºç®±</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('cultist')">
            <div class="class-title">ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’</div>
            <div class="class-desc">é–‹å±€è‡ªå¸¶<br>ä¸€å€‹æƒ¡é­”è©›å’’</div>
        </div>
    </div>
</div>

<div id="achieve-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;">ğŸ† æˆå°±åˆ—è¡¨</h2>
        <button onclick="document.getElementById('achieve-modal').style.display='none'" style="background:#555;">é—œé–‰</button>
    </div>
    <div id="achieve-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="achieve-list" id="achieve-list-content"></div>
</div>

<div id="compendium-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;">ğŸ“– ç‰©å“åœ–é‘‘</h2>
        <button onclick="document.getElementById('compendium-modal').style.display='none'" style="background:#555;">é—œé–‰</button>
    </div>
    <div id="compendium-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="compendium-container">
        <div class="compendium-grid" id="compendium-content"></div>
    </div>
</div>

<div id="game-container">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="font-weight: bold; font-size: 1.2em;">âš”ï¸ å¹»æƒ³å†’éšª</div>
            <button onclick="Game.showAchievements()" style="padding:4px 8px; font-size:0.8em;">ğŸ† æˆå°±</button>
            <button onclick="Game.showCompendium()" style="padding:4px 8px; font-size:0.8em; background:#673ab7;">ğŸ“– åœ–é‘‘</button>
        </div>
        <div class="badge-group">
            <div id="race-badge" class="race-badge"></div>
            <div id="class-badge" class="class-badge"></div>
        </div>
    </header>

<div class="stats-grid">
    <div class="stat-item">ç”Ÿå‘½: <span id="hp-val">100</span> / <span id="max-hp-val">100</span></div>
    <div class="stat-item">é­”åŠ›: <span id="mp-val" class="mp-text">50</span> / <span id="max-mp-val">50</span></div> <div class="stat-item">æ”»æ“Š: <span id="atk-val">5</span></div>
    <div class="stat-item">é‡‘å¹£: <span id="gold-val">100</span></div>
    <div class="stat-item">æ·±åº¦: <span id="depth-val">0</span> å±¤</div>
    <div id="buff-display" title="é»æ“ŠæŸ¥çœ‹è©³ç´°æ•ˆæœ">ç‹€æ…‹: ç„¡</div>
</div>

    <div id="event-display">
        <div id="event-icon" class="monster-icon">ğŸ²</div>
        <h3 id="event-title">æº–å‚™å†’éšª</h3>
        <div id="event-desc">è«‹å…ˆé¸æ“‡ç¨®æ—...</div>
        <div id="merchant-area" class="hidden"></div>
    </div>

    <div id="controls">
        <button id="btn-main" class="btn-primary" onclick="Game.nextEvent()">é–‹å§‹å†’éšª</button>
        <button id="btn-sub" onclick="Game.handleSubAction()" disabled>...</button>
    </div>

    <div id="inventory-section">
        <div class="equipment-slots">
            <div class="equip-slot" id="slot-weapon" onclick="Game.unequip('weapon')">ç„¡æ­¦å™¨</div>
            <div class="equip-slot" id="slot-armor" onclick="Game.unequip('armor')">ç„¡é˜²å…·</div>
            <div class="equip-slot" id="slot-shield" onclick="Game.unequip('shield')">ç„¡ç›¾ç‰Œ</div>
        </div>
        
        <div class="inv-container">
            <div class="inv-col">
                <h4>ğŸ“¦ è£å‚™</h4>
                <div class="item-list" id="inv-equip"></div>
            </div>
            <div class="inv-col">
                <h4>ğŸ§ª æ¶ˆè€—å“</h4>
                <div class="item-list" id="inv-consum"></div>
            </div>
            <div class="inv-col">
                <h4>ğŸ§© ç´ æ</h4>
                <div class="item-list" id="inv-mat"></div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <button onclick="Game.manualRestart()" style="width: 100%; background: #d32f2f; opacity: 0.8;">ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²</button>
    </div>
</div>

<script>
(function() {
const CONFIG = {
    rarityProb: { common: 0.40, uncommon: 0.3, rare: 0.15, epic: 0.05, legendary: 0.015, mythic: 0.0035, ultra: 0.0015 }, 
    rarityDisplay: {
        common: { color: "rarity-common", label: "ä¸€èˆ¬", val: 1 },
        uncommon: { color: "rarity-uncommon", label: "å„ªè³ª", val: 2 },
        rare: { color: "rarity-rare", label: "ç¨€æœ‰", val: 3 },
        epic: { color: "rarity-epic", label: "å²è©©", val: 4 },
        legendary: { color: "rarity-legendary", label: "å‚³èªª", val: 5 },
        mythic: { color: "rarity-mythic", label: "ç¥è©±", val: 6 },
        ultra: { color: "rarity-ultra", label: "æ¥µå‚³èªª", val: 7 }
    },
    buffs: {
        angel_song: { id: 'angel_song', name: 'ğŸ‘¼ å¤©ä½¿çš„æ­Œé Œ', type: 'angel', desc: 'æ¯æ¬¡äº‹ä»¶æ¢å¾© 20 HP' },
        angel_protection: { id: 'angel_protection', name: 'ğŸ›¡ï¸ å¤©ä½¿çš„åŠ è­·', type: 'angel', desc: 'æ€ªç‰©é€ æˆçš„å‚·å®³æ¸›å°‘ 30%' },
        angel_courage: { id: 'angel_courage', name: 'âš”ï¸ å¤©ä½¿çš„å‹‡æ°£', type: 'angel', desc: 'è‡´å‘½ä¸€æ“Šæ©Ÿç‡æå‡è‡³ 20%' },
        angel_wings: { id: 'angel_wings', name: 'ğŸ•Šï¸ å¤©ä½¿çš„ç¿…è†€', type: 'angel', desc: 'é€ƒè·‘æˆåŠŸç‡å¾50%æå‡è‡³ 70%' },
        demon_wealth: { id: 'demon_wealth', name: 'ğŸ’° æƒ¡é­”çš„è²¡å¯Œ', type: 'demon', desc: 'æ”»æ“Šå¾—5é‡‘å¹£ï¼Œä½†é€ƒè·‘å¤±æ•—è¢«æ”»æ“Šæ™‚æ‰£5é‡‘å¹£' },
        demon_destruction: { id: 'demon_destruction', name: 'ğŸ’€ æƒ¡é­”çš„ç ´å£', type: 'demon', desc: '10%æ©Ÿç‡ç§’æ®ºæ€ªç‰©ï¼Œè§¸ç™¼å¾Œæ‰£é™¤ç•¶å‰è¡€é‡90%' },
        demon_enhance: { id: 'demon_enhance', name: 'ğŸ”¥ æƒ¡é­”çš„å¼·åŒ–', type: 'demon', desc: 'é›™æ–¹è‡´å‘½ä¸€æ“Šæ©Ÿç‡è®Šç‚º 50%' },
        demon_wager: { id: 'demon_wager', name: 'ğŸ² æƒ¡é­”çš„è³­ç´„', type: 'demon', desc: 'é€ƒè·‘ç‡85%ï¼Œä½†æ¯æ¬¡é€ƒè·‘æœ‰1.5%æ©Ÿç‡ç›´æ¥æ­»äº¡' }
    },
   monsters: [
    // å‰æœŸæ€ªç‰© (1-6å±¤): æ•¸å€¼ç•¥ç‚ºä¸Šèª¿ï¼Œé‡‘å¹£ç¿»å€
    { name: "å²èŠå§†", weight: 12, baseGold: 2, icon: "ğŸ¦ ", hp: 35, atk: 6, drop: "å²èŠå§†é»æ¶²", eliteDrop: "å²èŠå§†ç²¾è¯", bossDrop: "å²èŠå§†ç‹å† " },
    { name: "å“¥å¸ƒæ—", weight: 12, baseGold: 4, icon: "ğŸ‘º", hp: 55, atk: 9, drop: "ç ´å¸ƒ", eliteDrop: "å“¥å¸ƒæ—è€³ç’°", bossDrop: "å“¥å¸ƒæ—é‡‘ç‰™" },
    { name: "å·¨å‹èœ˜è››", weight: 10, baseGold: 5, icon: "ğŸ•·ï¸", hp: 65, atk: 11, drop: "èœ˜è››çµ²", eliteDrop: "æ¯’å›Š", bossDrop: "åŠ‡æ¯’ç ç‰™" },
    { name: "ç‹‚ç‹¼", weight: 10, baseGold: 6, icon: "ğŸº", hp: 75, atk: 13, drop: "ç‹¼çš®", eliteDrop: "ç‹¼ç‰™", bossDrop: "ç‹¼ç‹æŠ«é¢¨" },
    { name: "å¸è¡€è™è ", weight: 8, baseGold: 8, icon: "ğŸ¦‡", hp: 65, atk: 14, drop: "è™è ç¿…è†€", eliteDrop: "å¸è¡€é¬¼ä¹‹å¡µ", bossDrop: "è¡€è…¥è­·ç¬¦" },
    { name: "éª·é«å…µ", weight: 10, baseGold: 8, icon: "ğŸ’€", hp: 85, atk: 16, drop: "éª¨é ­", eliteDrop: "éˆé­‚ç¢ç‰‡", bossDrop: "æ­»éˆé ­éª¨" },
    
    // ä¸­æœŸæ€ªç‰© (7-10å±¤): æ•¸å€¼æ˜é¡¯ä¸Šèª¿ï¼Œé‡‘å¹£å¢åŠ  50%
    { name: "åŠç¸äºº", weight: 10, baseGold: 12, icon: "ğŸ‘¹", hp: 120, atk: 19, drop: "æ–·åŠ", eliteDrop: "åŠç¸äººè­·ç¬¦", bossDrop: "æˆ°çˆ­è™Ÿè§’" },
    { name: "å¹½éˆ", weight: 8, baseGold: 15, icon: "ğŸ‘»", hp: 100, atk: 23, drop: "éˆè³ª", eliteDrop: "æ€¨å¿µé›†åˆé«”", bossDrop: "å¹½éˆæç‡ˆ" },
    { name: "çŸ³å·¨äºº", weight: 7, baseGold: 25, icon: "ğŸ—¿", hp: 250, atk: 31, drop: "çŸ³å¡Š", eliteDrop: "é­”åŠ›æ ¸å¿ƒ", bossDrop: "å¤§åœ°ä¹‹å¿ƒ" },
    { name: "é»‘æš—é¨å£«", weight: 5, baseGold: 30, icon: "â™Ÿï¸", hp: 300, atk: 36, drop: "é»‘æš—é‡‘å±¬", eliteDrop: "å¢®è½å¾½ç« ", bossDrop: "é»‘é¨å£«ä¹‹ç›”" },
    
    // å¾ŒæœŸæ€ªç‰© (11-14å±¤): æ•¸å€¼å¤§å¹…ä¸Šèª¿ï¼Œé‡‘å¹£ç¿»å€
    { name: "é£Ÿäººå¦–", weight: 4, baseGold: 50, icon: "ğŸ§Ÿ", hp: 400, atk: 40, drop: "å·¨æ£’", eliteDrop: "é£Ÿäººå¦–ä¹‹è¡€", bossDrop: "é£Ÿäººå¦–åœ–é¨°" },
    { name: "å¥‡ç¾æ‹‰", weight: 3, baseGold: 60, icon: "ğŸ¦", hp: 500, atk: 50, drop: "å¥‡ç¾æ‹‰ä¹‹ç‰™", eliteDrop: "åˆæˆç¸çš®æ¯›", bossDrop: "æ··æ²Œä¹‹æ ¸" },
    { name: "é›™è¶³é£›é¾", weight: 2, baseGold: 80, icon: "ğŸ‰", hp: 660, atk: 60, drop: "é¾é±—", eliteDrop: "é¾ä¹‹æ·š", bossDrop: "é¾å¿ƒ" },
    { name: "å·«å¦–", weight: 1.5, baseGold: 90, icon: "ğŸ§™", hp: 500, atk: 72, drop: "è©›å’’å¸ƒæ–™", eliteDrop: "å‘½åŒ£", bossDrop: "äº¡éˆæ³•æ›¸" },
    
    // æœ€çµ‚æ€ªç‰© (15-16å±¤): æ•¸å€¼ç¿»å€ï¼Œæˆç‚ºçœŸæ­£çš„å¼·æ•µ
    { name: "é å¤å·¨é¾", weight: 0.5, baseGold: 200, icon: "ğŸ¦–", hp: 900, atk: 85, drop: "é¾éª¨", eliteDrop: "é¾è¡€ç“¶", bossDrop: "é¾ç¥é€†é±—" },
    { name: "é­”ç‹", weight: 1, baseGold: 100, icon: "ğŸ‘¿", hp: 1000, atk: 100, drop: "é»‘æš—ç‰©è³ª", eliteDrop: "é­”ç‹å°è¨˜", bossDrop: "é­”ç¥ä¹‹çœ¼" }
],
    lootData: {
        "å²èŠå§†é»æ¶²": { price: 10, rarity: "common", icon: "ğŸ’§" },
        "å²èŠå§†ç²¾è¯": { price: 50, rarity: "uncommon", icon: "âœ¨" },
        "å²èŠå§†ç‹å† ": { price: 200, rarity: "rare", icon: "ğŸ‘‘" },
        "ç ´å¸ƒ": { price: 15, rarity: "common", icon: "ğŸ§¶" },
        "å“¥å¸ƒæ—è€³ç’°": { price: 60, rarity: "uncommon", icon: "ğŸ’" },
        "å“¥å¸ƒæ—é‡‘ç‰™": { price: 250, rarity: "rare", icon: "ğŸ¦·" },
        "èœ˜è››çµ²": { price: 18, rarity: "common", icon: "ğŸ•¸ï¸" },
        "æ¯’å›Š": { price: 70, rarity: "uncommon", icon: "ğŸŸ£" },
        "åŠ‡æ¯’ç ç‰™": { price: 280, rarity: "rare", icon: "ğŸ§›" },
        "ç‹¼çš®": { price: 20, rarity: "common", icon: "ğŸ§µ" },
        "ç‹¼ç‰™": { price: 80, rarity: "uncommon", icon: "ğŸ¦´" },
        "ç‹¼ç‹æŠ«é¢¨": { price: 300, rarity: "rare", icon: "ğŸ§£" },
        "è™è ç¿…è†€": { price: 22, rarity: "common", icon: "ğŸ¦‡" },
        "å¸è¡€é¬¼ä¹‹å¡µ": { price: 90, rarity: "uncommon", icon: "ğŸŒ«ï¸" },
        "è¡€è…¥è­·ç¬¦": { price: 320, rarity: "rare", icon: "ğŸ©¸" },
        "éª¨é ­": { price: 25, rarity: "common", icon: "ğŸ¦´" },
        "éˆé­‚ç¢ç‰‡": { price: 100, rarity: "uncommon", icon: "ğŸ‘»" },
        "æ­»éˆé ­éª¨": { price: 350, rarity: "rare", icon: "ğŸ’€" },
        "æ–·åŠ": { price: 30, rarity: "common", icon: "ğŸ—¡ï¸" },
        "åŠç¸äººè­·ç¬¦": { price: 120, rarity: "uncommon", icon: "ğŸ§¿" },
        "æˆ°çˆ­è™Ÿè§’": { price: 400, rarity: "rare", icon: "ğŸ“¯" },
        "éˆè³ª": { price: 35, rarity: "common", icon: "ğŸŒ«ï¸" },
        "æ€¨å¿µé›†åˆé«”": { price: 150, rarity: "uncommon", icon: "ğŸ‘¿" },
        "å¹½éˆæç‡ˆ": { price: 450, rarity: "rare", icon: "ğŸ®" },
        "çŸ³å¡Š": { price: 50, rarity: "common", icon: "ğŸª¨" },
        "é­”åŠ›æ ¸å¿ƒ": { price: 200, rarity: "rare", icon: "ğŸ”®" },
        "å¤§åœ°ä¹‹å¿ƒ": { price: 600, rarity: "epic", icon: "ğŸ’" },
        "é»‘æš—é‡‘å±¬": { price: 55, rarity: "common", icon: "ğŸ”©" },
        "å¢®è½å¾½ç« ": { price: 220, rarity: "rare", icon: "ğŸ“›" },
        "é»‘é¨å£«ä¹‹ç›”": { price: 650, rarity: "epic", icon: "ğŸª–" },
        "å·¨æ£’": { price: 60, rarity: "common", icon: "ğŸªµ" },
        "é£Ÿäººå¦–ä¹‹è¡€": { price: 250, rarity: "rare", icon: "ğŸ©¸" },
        "é£Ÿäººå¦–åœ–é¨°": { price: 700, rarity: "epic", icon: "ğŸ—¿" },
        "å¥‡ç¾æ‹‰ä¹‹ç‰™": { price: 70, rarity: "common", icon: "ğŸ¦·" },
        "åˆæˆç¸çš®æ¯›": { price: 300, rarity: "rare", icon: "ğŸ†" },
        "æ··æ²Œä¹‹æ ¸": { price: 750, rarity: "epic", icon: "âš›ï¸" },
        "é¾é±—": { price: 100, rarity: "uncommon", icon: "ğŸ›¡ï¸" },
        "é¾ä¹‹æ·š": { price: 400, rarity: "rare", icon: "ğŸ’§" },
        "é¾å¿ƒ": { price: 800, rarity: "epic", icon: "â¤ï¸" },
        "è©›å’’å¸ƒæ–™": { price: 120, rarity: "uncommon", icon: "ğŸ§£" },
        "å‘½åŒ£": { price: 500, rarity: "epic", icon: "ğŸº" },
        "äº¡éˆæ³•æ›¸": { price: 900, rarity: "epic", icon: "ğŸ“–" },
        "é¾éª¨": { price: 200, rarity: "rare", icon: "ğŸ¦´" },
        "é¾è¡€ç“¶": { price: 600, rarity: "epic", icon: "ğŸ§ª" },
        "é¾ç¥é€†é±—": { price: 1200, rarity: "legendary", icon: "ğŸ²" },
        "é»‘æš—ç‰©è³ª": { price: 200, rarity: "rare", icon: "âš«" },
        "é­”ç‹å°è¨˜": { price: 500, rarity: "epic", icon: "ğŸ”¯" },
        "é­”ç¥ä¹‹çœ¼": { price: 1000, rarity: "legendary", icon: "ğŸ‘ï¸" },
        "çœŸå¯¦ä¹‹å¿ƒ": { price: 5000, rarity: "mythic", icon: "ğŸ’–" }
    },
    itemPool: [
    // Common (ä¸€èˆ¬) - å¢åŠ é ­ç›”å’Œè¼•ç”²
    { name: "ç”Ÿé½åŒ•é¦–", type: "weapon", val: 3, rarity: "common", price: 15, icon: "ğŸ—¡ï¸" },
    { name: "æœ¨æ£’", type: "weapon", val: 4, rarity: "common", price: 20, icon: "ğŸªµ" },
    { name: "åˆºå®¢çŸ­åˆ€", type: "weapon", val: 6, rarity: "common", price: 30, icon: "ğŸ”ª" },
    { name: "å¸ƒè¡£", type: "armor", val: 10, rarity: "common", price: 15, icon: "ğŸ‘•" },
    { name: "çš®ç”²", type: "armor", val: 15, rarity: "common", price: 25, icon: "ğŸ§¥" },
    { name: "æœ¨ç›¾", type: "shield", val: 1, rarity: "common", price: 20, icon: "ğŸ›¡ï¸" },
    { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" },
    { name: "è¼•å‹é ­ç›”", type: "armor", val: 5, rarity: "common", price: 10, icon: "ğŸª–" }, // [æ–°å¢]
    
    // Uncommon (å„ªè³ª) - å¢åŠ é•·åŠå’Œç¡¬çš®ç”²
    { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" },
    { name: "éµåŠ", type: "weapon", val: 15, rarity: "uncommon", price: 90, icon: "âš”ï¸" },
    { name: "æˆ°æ–§", type: "weapon", val: 18, rarity: "uncommon", price: 100, icon: "ğŸª“" },
    { name: "é–å­ç”²", type: "armor", val: 40, rarity: "uncommon", price: 80, icon: "ğŸ›¡ï¸" },
    { name: "æ—…è¡Œè€…æ–—ç¯·", type: "armor", val: 35, rarity: "uncommon", price: 70, icon: "ğŸ§¥" },
    { name: "éµç›¾", type: "shield", val: 2, rarity: "uncommon", price: 60, icon: "ğŸ›¡ï¸" },
    { name: "å¼·åŠ›è—¥æ°´", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "æ¢å¾©80é»ç”Ÿå‘½" },
    { name: "é•·åŠ", type: "weapon", val: 16, rarity: "uncommon", price: 95, icon: "ğŸ—¡ï¸" }, // [æ–°å¢]
    { name: "ç¡¬çš®ç”²", type: "armor", val: 50, rarity: "uncommon", price: 90, icon: "ğŸ§¥" }, // [æ–°å¢]
    
    // Rare (ç¨€æœ‰) - å¢åŠ æˆ°éŒ˜å’Œå…¨èº«é§
    { name: "ç§˜éŠ€åŠ", type: "weapon", val: 30, rarity: "rare", price: 250, icon: "âš”ï¸" },
    { name: "ç²¾éˆé•·å¼“", type: "weapon", val: 35, rarity: "rare", price: 280, icon: "ğŸ¹" },
    { name: "å·¨åŠ", type: "weapon", val: 40, rarity: "rare", price: 300, icon: "ğŸ—¡ï¸" },
    { name: "æ¿ç”²", type: "armor", val: 100, rarity: "rare", price: 250, icon: "ğŸ›¡ï¸" },
    { name: "é­”æ³•å¸«é•·è¢", type: "armor", val: 80, rarity: "rare", price: 220, icon: "ğŸ‘˜" },
    { name: "é¨å£«ç›¾", type: "shield", val: 3, rarity: "rare", price: 300, icon: "ğŸ›¡ï¸" },
    { name: "ç²¾éˆè—¥åŠ‘", type: "consumable", val: 200, rarity: "rare", price: 150, icon: "ğŸ§‰", desc: "æ¢å¾©200é»ç”Ÿå‘½" },
    { name: "æˆ°éŒ˜", type: "weapon", val: 45, rarity: "rare", price: 350, icon: "ğŸ”¨" }, // [æ–°å¢]
    { name: "å…¨èº«é§", type: "armor", val: 120, rarity: "rare", price: 300, icon: "ğŸ›¡ï¸" }, // [æ–°å¢]

    // Epic (å²è©©) - å¢åŠ å…ƒç´ æ³•æ–å’Œå·¨å‹ç›¾
    { name: "å± é¾åŠ", type: "weapon", val: 60, rarity: "epic", price: 800, icon: "ğŸ‰" },
    { name: "æš—å½±æ¬Šæ–", type: "weapon", val: 65, rarity: "epic", price: 850, icon: "ğŸ¦¯" },
    { name: "é¾é±—é§ç”²", type: "armor", val: 250, rarity: "epic", price: 800, icon: "ğŸ¥‹" },
    { name: "æš—å½±æ–—ç¯·", type: "armor", val: 220, rarity: "epic", price: 750, icon: "ğŸ§›" },
    { name: "å¡”ç›¾", type: "shield", val: 5, rarity: "epic", price: 500, icon: "ğŸ§±" },
    { name: "çš‡å®¶ç›¾ç‰Œ", type: "shield", val: 6, rarity: "epic", price: 600, icon: "ğŸ›¡ï¸" },
    { name: "å…¨èƒ½è—¥æ°´", type: "consumable", val: 500, rarity: "epic", price: 400, icon: "ğŸº", desc: "æ¢å¾©500é»ç”Ÿå‘½" },
    { name: "å…ƒç´ æ³•æ–", type: "weapon", val: 75, rarity: "epic", price: 1000, icon: "âœ¨" }, // [æ–°å¢]
    { name: "å·¨å‹ç›¾", type: "shield", val: 8, rarity: "epic", price: 700, icon: "ğŸ›¡ï¸" }, // [æ–°å¢]
    
    // Legendary (å‚³èªª) - å¢åŠ æˆ°ç¥å·¨æ–§ (æ³¨é‡æ”»æ“Š)
    { name: "è–åŠ Excalibur", type: "weapon", val: 150, rarity: "legendary", price: 2500, icon: "ğŸŒŸ" },
    { name: "é›·ç¥ä¹‹éŒ˜", type: "weapon", val: 180, rarity: "legendary", price: 2800, icon: "ğŸ”¨" },
    { name: "ç¥ä¹‹å…‰è¼", type: "armor", val: 400, rarity: "legendary", price: 2000, icon: "ğŸŒ" },
    { name: "å¥§ä¸æˆ°ç”²", type: "armor", val: 500, rarity: "legendary", price: 2600, icon: "ğŸ’‚" },
    { name: "åŸƒç™¸æ–¯ä¹‹ç›¾", type: "shield", val: 10, rarity: "legendary", price: 900, icon: "ğŸ”±" },
    { name: "å†¥ç‹ä¹‹ç›¾", type: "shield", val: 12, rarity: "legendary", price: 1200, icon: "ğŸ›¡ï¸" },
    { name: "æˆ°ç¥å·¨æ–§", type: "weapon", val: 220, rarity: "legendary", price: 3500, icon: "ğŸª“" }, // [æ–°å¢]

    // Mythic & Ultra (ç¥è©±èˆ‡æ¥µå‚³èªª) - å¢åŠ å®ˆè­·è€…é§ç”² (æ³¨é‡é˜²ç¦¦)
    { name: "ç„¡é™æ‰‹å¥—", type: "weapon", val: 300, rarity: "mythic", price: 5000, icon: "ğŸ¥Š" },
    { name: "çµ•å°é˜²ç¦¦", type: "armor", val: 1000, rarity: "mythic", price: 5000, icon: "ğŸŒŒ" },
    { name: "å®ˆè­·è€…é§ç”²", type: "armor", val: 1500, rarity: "ultra", price: 7000, icon: "ğŸ¥‹" }, // [æ–°å¢]
    { name: "å¦–åˆ€æ‘æ­£", type: "weapon", val: 500, rarity: "ultra", price: 7000, icon: "ğŸ—¡ï¸", desc: "å—è©›å’’çš„å¦–åˆ€ï¼Œ+20% æš´æ“Šç‡" }
],
// ... åœ¨ itemPool ä¹‹å¾ŒåŠ å…¥
skills: {
        // ==========================================
        // Common (ä¸€èˆ¬) - åŸºç¤æˆ°æŠ€èˆ‡ç”Ÿå­˜
        // ==========================================
        "heavy_strike": { 
            id: "heavy_strike", name: "é‡æ“Š", rarity: "common", mpCost: 30, 
            desc: "åŸºç¤æˆ°æŠ€ï¼Œé€ æˆ 1.25 å€çš„å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.25, text: "æ®å‡ºé‡é‡çš„ä¸€æ“Šï¼" }) 
        },
        "quick_stab": { 
            id: "quick_stab", name: "çªåˆº", rarity: "common", mpCost: 15, 
            desc: "å¿«é€Ÿçš„ä¸€æ“Šï¼Œæ¶ˆè€—æ¥µä½ã€‚é€ æˆ 1.1 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.1, text: "è¿…é€Ÿåˆºå‘æ•µäººï¼" }) 
        },
        "stone_throw": { 
            id: "stone_throw", name: "æŠ•çŸ³", rarity: "common", mpCost: 20, 
            desc: "å›ºå®šå‚·å®³æ”»æ“Š (40é»)ã€‚",
            effect: (p, e) => ({ flatDmg: 40, dmgMult: 0, text: "æ’¿èµ·çŸ³é ­ç”¨åŠ›ä¸Ÿéå»ï¼" }) 
        },
        "first_aid": { 
            id: "first_aid", name: "æ€¥æ•‘", rarity: "common", mpCost: 40, 
            desc: "ç°¡å–®çš„åŒ…ç´®ï¼Œæ¢å¾© 15% æœ€å¤§ç”Ÿå‘½ã€‚",
            effect: (p, e) => ({ healPct: 0.15, text: "é€²è¡Œäº†ç·Šæ€¥åŒ…ç´®ã€‚", type: "heal" }) 
        },
        // [æ–°å¢] ä¸€èˆ¬æŠ€èƒ½ 1ï¼šä½è€—é­”é­”æ³•
        "spark": { 
            id: "spark", name: "å°ç«èŠ±", rarity: "common", mpCost: 25, 
            desc: "é€ æˆ 15 é»å›ºå®š + 1.0 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.0, flatDmg: 15, text: "æŒ‡å°–å½ˆå‡ºå°ç«èŠ±ï¼", anim: "glow-red" }) 
        },
        // [æ–°å¢] ä¸€èˆ¬æŠ€èƒ½ 2ï¼šæ¥µä½è€—é«”è¡“
        "kick": { 
            id: "kick", name: "è¸¢æ“Š", rarity: "common", mpCost: 15, 
            desc: "ç¨å¾®ç”¨åŠ›çš„è¸¢æ“Šï¼Œé€ æˆ 25 é»å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 0, flatDmg: 25, text: "ç‹ ç‹ åœ°è¸¢äº†ä¸€è…³ï¼" }) 
        },

        // ==========================================
        // Uncommon (å„ªè³ª) - é€²éšæŠ€å·§
        // ==========================================
        "double_cut": { 
            id: "double_cut", name: "äºŒé€£æ–¬", rarity: "uncommon", mpCost: 45, 
            desc: "é€£çºŒæ”»æ“Šå…©æ¬¡ï¼Œå…±é€ æˆ 1.5 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.5, text: "ä½¿å‡ºäºŒé€£æ–¬ï¼" }) 
        },
        "wind_blade": { 
            id: "wind_blade", name: "é¢¨åˆƒ", rarity: "uncommon", mpCost: 50, 
            desc: "å¬å–šé¢¨åˆƒï¼Œé€ æˆ 20 é»å›ºå®š +  1.4 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.4, flatDmg: 20, text: "ç„¡å½¢çš„é¢¨åˆƒåˆ‡è£‚ç©ºæ°£ï¼", anim: "glow-blue" }) 
        },
        // [æ–°å¢] å„ªè³ªæŠ€èƒ½ 1ï¼šå¸è¡€é¡ (çºŒæˆ°åŠ›)
        "drain_strike": { 
            id: "drain_strike", name: "å¸è¡€æ–¬", rarity: "uncommon", mpCost: 60, 
            desc: "é€ æˆ 1.2 å€å‚·å®³ï¼Œä¸¦å°‡å‚·å®³è½‰åŒ–ç‚ºå¾®é‡æ²»ç™‚ã€‚",
            effect: (p, e) => ({ dmgMult: 1.2, healPct: 0.05, text: "åŠåˆƒæ³›è‘—å—œè¡€çš„ç´…å…‰ï¼", anim: "glow-red" }) 
        },
        // [æ–°å¢] å„ªè³ªæŠ€èƒ½ 2ï¼šç´”ç‰©ç†çˆ†ç™¼
        "bone_crusher": { 
            id: "bone_crusher", name: "ç¢éª¨æ“Š", rarity: "uncommon", mpCost: 55, 
            desc: "å¼·åŠ›çš„ä¸€æ“Šï¼Œé€ æˆ 1.7 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.7, text: "ç™¼å‡ºéª¨é ­ç¢è£‚çš„è²éŸ³ï¼" }) 
        },

        // ==========================================
        // Rare (ç¨€æœ‰) - å…ƒç´ èˆ‡é­”æ³•
        // ==========================================
        "fireball": { 
            id: "fireball", name: "ç«çƒè¡“", rarity: "rare", mpCost: 70, 
            desc: "é€ æˆ 30 é»å›ºå®š + 1.6 å€çš„å‚·å®³ã€‚",
            effect: (p, e) => ({ flatDmg: 30, dmgMult: 1.6, text: "ç™¼å°„äº†ä¸€æšç†¾ç†±çš„ç«çƒï¼", anim: "glow-red" }) 
        },
        "ice_spear": { 
            id: "ice_spear", name: "å†°æ§è¡“", rarity: "rare", mpCost: 75, 
            desc: "è²«ç©¿æ•µäººçš„å†°æ§ï¼Œé€ æˆ 1.8 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 1.8, text: "å¯’å†°å‡èšæˆæ§ï¼Œå°„å‘æ•µäººï¼", anim: "glow-blue" }) 
        },
        // [æ–°å¢] ç¨€æœ‰æŠ€èƒ½ 1ï¼šæš—å½±é«˜å‚·
        "shadow_dance": { 
            id: "shadow_dance", name: "å½±ä¹‹èˆ", rarity: "rare", mpCost: 90, 
            desc: "åŒ–èº«æš—å½±é€²è¡Œé€£æ“Šï¼Œé€ æˆ 2.2 å€å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 2.2, text: "åœ¨é™°å½±ä¸­çœ‹ä¸è¦‹çš„é€£æ“Šï¼", anim: "glow-purple" }) 
        },

        // ==========================================
        // Epic (å²è©©) - å¼·å¤§çš„ç¥è–èˆ‡è‡ªç„¶ä¹‹åŠ›
        // ==========================================
        "heal_light": { 
            id: "heal_light", name: "è–å…‰è¡“", rarity: "epic", mpCost: 100, 
            desc: "æ¢å¾© 40% æœ€å¤§ç”Ÿå‘½å€¼ (ä¸é€ æˆå‚·å®³)ã€‚",
            effect: (p, e) => ({ healPct: 0.4, dmgMult: 0, text: "æ²æµ´åœ¨è–å…‰ä¹‹ä¸­...", type: "heal" }) 
        },
        "thunder_storm": { 
            id: "thunder_storm", name: "é›·éœ†è¬éˆ", rarity: "epic", mpCost: 120, 
            desc: "å¬å–šè½é›·ï¼Œé€ æˆ 2.5 å€çš„å¼·åŠ›å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 2.5, text: "å¤©ç©ºé™ä¸‹ç‹‚é›·ï¼", anim: "glow-blue" }) 
        },

        // ==========================================
        // Legendary (å‚³èªª) - æ¯€å¤©æ»…åœ°
        // ==========================================
        "god_slash": { 
            id: "god_slash", name: "ç¥æ»…æ–¬", rarity: "legendary", mpCost: 200, 
            desc: "é€ æˆ 5 å€æ”»æ“ŠåŠ›çš„æ¯€æ»…æ€§å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 5.0, text: "é€£ç©ºé–“éƒ½åˆ‡é–‹çš„ä¸€æ“Šï¼", anim: "glow-purple" }) 
        },
        // [æ–°å¢] å‚³èªªæŠ€èƒ½ 1ï¼šé¾æ—ä¹‹åŠ›
        "dragon_fury": { 
            id: "dragon_fury", name: "é¾ä¹‹æ€’", rarity: "legendary", mpCost: 180, 
            desc: "å™´å‡ºé¾æ¯ï¼Œé€ æˆ 200 é»å›ºå®š + 3.5 å€çš„å‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 3.5, flatDmg: 200, text: "è¢«æ¯€æ»…æ€§çš„é¾æ¯åæ²’ï¼", anim: "glow-red" }) 
        },

        // ==========================================
        // Mythic / Ultra (ç¥è©±/æ¥µå‚³èªª) - è¦å‰‡ç ´å£è€…
        // ==========================================
        "genesis": { 
            id: "genesis", name: "å‰µä¸–ä¹‹å…‰", rarity: "mythic", mpCost: 350, 
            desc: "å®Œå…¨æ¢å¾©æ‰€æœ‰ç”Ÿå‘½å€¼ã€‚",
            effect: (p, e) => ({ healPct: 1.0, text: "è¦‹è­‰å¥‡è¹Ÿçš„æ™‚åˆ»ï¼", type: "heal" }) 
        },
        "void_collapse": { 
            id: "void_collapse", name: "è™›ç©ºå´©å¡Œ", rarity: "ultra", mpCost: 500, 
            desc: "é€ æˆ 15 å€æ”»æ“ŠåŠ›çš„çµ‚æ¥µå‚·å®³ã€‚",
            effect: (p, e) => ({ dmgMult: 15.0, text: "ä¸–ç•Œåœ¨è™›ç©ºä¸­æ­¸æ–¼è™›ç„¡...", anim: "glow-purple" }) 
        }
    },
    // ...
    phoenixFeather: {
        id: "phoenix_feather",
        name: "ä¸æ­»é³¥çš„ç¾½æ¯›",
        type: "revive",
        rarity: "legendary",
        icon: "ğŸª¶",
        price: 0,
        desc: "æ­»äº¡æ™‚ä»¥50%ç”Ÿå‘½å¾©æ´»ï¼Œç„¡æ³•å‡ºå”®"
    },
    achievements: [
        { id: "abyss_50", name: "æ·±æ·µè¸å…¥è€…", cond: "é€šéç¬¬ 50 å±¤", rarity: "common", check: (p) => p.depth >= 50 },
        { id: "abyss_100", name: "ä¸å±ˆæ¢ç´¢è€…", cond: "é€šéç¬¬ 100 å±¤", rarity: "rare", check: (p) => p.depth >= 100 },
        { id: "abyss_500", name: "æ·±æ·µç‹è€…", cond: "é€šéç¬¬ 500 å±¤", rarity: "epic", check: (p) => p.depth >= 500 },
        { id: "abyss_1000", name: "æ°¸å¤œæ¼«éŠè€…", cond: "é€šéç¬¬ 1000 å±¤", rarity: "legendary", check: (p) => p.depth >= 1000 },
        { id: "hero_kill", name: "å‹‡è€…?", cond: "åœ¨ 1000 å±¤æ“Šæ•—æ·±å±¤é¦–é ˜é­”ç‹", rarity: "legendary", check: (p) => p.kill1000Boss },
        { id: "collector", name: "æ”¶è—å®¶", cond: "æ”¶é›† 30 ç¨®ä¸åŒç‰©å“", rarity: "common", check: (p) => p.history.items.size >= 30 },
        { id: "wealth", name: "å¯Œç¿", cond: "æŒæœ‰ 5000 é‡‘å¹£", rarity: "rare", check: (p) => p.gold >= 5000 },
        { id: "researcher", name: "æ€ªç‰©ç ”ç©¶å“¡", cond: "å–å¾—æ‰€æœ‰ä¸€èˆ¬èˆ‡èè‹±æ‰è½ç‰©(é™¤çœŸå¯¦ä¹‹å¿ƒ)", rarity: "epic", check: (p) => Game.checkDrops('researcher') },
        { id: "prospector", name: "æ€ªç‰©æ¢å‹˜è€…", cond: "å–å¾—æ‰€æœ‰ä¸€èˆ¬ã€èè‹±ã€é¦–é ˜æ‰è½ç‰©(é™¤çœŸå¯¦ä¹‹å¿ƒ)", rarity: "legendary", check: (p) => Game.checkDrops('prospector') },
        { id: "phoenix", name: "ä¸æ­»é³¥çš„é¸ä¸­", cond: "å–å¾—ã€Œä¸æ­»é³¥çš„ç¾½æ¯›ã€", rarity: "legendary", check: (p) => p.history.items.has("ä¸æ­»é³¥çš„ç¾½æ¯›") },
        // Hidden
        { id: "rest", name: "ä¼‘æ¯?", cond: "å–å¾—æ‰€æœ‰æ™®é€šåˆ°å‚³èªªçš„æˆå°±", rarity: "mythic", hidden: true, check: (p) => Game.checkTierComplete(['common','rare','epic','legendary']) },
        { id: "hero_true", name: "å‹‡è€…", cond: "ç²å¾—çœŸå¯¦ä¹‹å¿ƒ", rarity: "mythic", hidden: true, check: (p) => p.history.items.has("çœŸå¯¦ä¹‹å¿ƒ") },
        { id: "answer", name: "ç­”æ¡ˆ", cond: "ç²å¾—æ‰€æœ‰ç‰©å“", rarity: "mythic", hidden: true, check: (p) => Game.checkAllItems() },
        { id: "true_rest", name: "ç™¼è‡ªå¿ƒéˆçš„ä¼‘æ¯", cond: "ç²å¾—æ‰€æœ‰æˆå°±", rarity: "ultra", hidden: true, check: (p) => Game.checkAllAchievements() }
    ]
};

// åœ¨ script é–‹é ­é™„è¿‘çš„ Player ç‰©ä»¶
const Player = {
    hp: 100,
    maxHp: 100,
    mp: 120,        // <--- [è£œä¸Šé€™è¡Œ]
    maxMp: 120,     // <--- [è£œä¸Šé€™è¡Œ]
    baseAtk: 5,
    gold: 100, 
    depth: 0,
    class: null,
    race: null,
    gender: null,      // [æ–°å¢]
    orientation: null, // [æ–°å¢]
    skills: ["quick_stab","heavy_strike","kick","stone_throw", "double_cut", "wind_blade", "spark", "fireball", "shadow_dance", "first_aid", "heal_light", "god_slash"],
    equipment: { weapon: null, armor: null, shield: null },
    inventory: { 
        equipment: [
	    { name: "ç”Ÿé½åŒ•é¦–", type: "weapon", val: 3, rarity: "common", price: 15, icon: "ğŸ—¡ï¸" },
    	    { name: "è¼•å‹é ­ç›”", type: "armor", val: 5, rarity: "common", price: 10, icon: "ğŸª–" }
], 
        consumable: [
            { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" }
],

        material: [] 
    },
    buff: null,
    achievements: new Set(),
    history: { items: new Set() },
    kill1000Boss: false,
    hasTriggeredHiddenWager: false,
    dailyRefreshCount: 0 
};

const GameState = {
    phase: "select_race",
    combatSubPhase: null, // [æ–°å¢] null=ä¸»é¸å–®, 'action'=æ”»æ“Šé¸å–®, 'skill'=æŠ€èƒ½é¸å–®
    currentEnemy: null,
    merchantStock: [],
    log: [],
    isLoading: false,
    skipNextRegen: false // [æ–°å¢] ç”¨ä¾†æ§åˆ¶æˆ°é¬¥å‹åˆ©å¾Œæ˜¯å¦è·³é nextEvent çš„å›è¡€
};

const Game = {
    init() {
        // --- 1. è‡ªå‹•æª¢æŸ¥å­˜æª” ---
        if (localStorage.getItem('fantasy_adventure_save')) {
            this.loadGame();
        } else {
            // å¦‚æœæ²’æœ‰å­˜æª”ï¼ŒåŸ·è¡Œåˆå§‹åŒ–è¨­ç½®
            this.updateUI();
            
            // --- 2. é¡¯ç¤ºç¨®æ—é¸æ“‡ç•«é¢ ---
            // é€™æ˜¯ä¿®æ­£ï¼šç¢ºä¿åœ¨æ²’æœ‰å­˜æª”æ™‚ï¼Œé¸å–®æœƒæ‰‹å‹•é¡¯ç¤ºå‡ºä¾†
            document.getElementById('race-modal').style.display = 'flex'; 
        }
        
        // --- 3. GM æ¨¡å¼è‡ªå‹•æª¢æŸ¥èˆ‡å•Ÿå‹• (L230) ---
        if (localStorage.getItem('gm_enabled') === 'true') {
            GM.toggle(true);
        }
    },

    // --- Save & Load System (Encrypted) ---
    saveGame() {

    if (Player.hp <= 0 || GameState.phase === 'dead') {
            // æ­»äº¡æ™‚æ¸…é™¤å­˜æª”
            localStorage.removeItem('fantasy_adventure_save');
            return;
        }
        if (!Player.class || !Player.race) return; //é‚„æ²’é¸è·æ¥­/ç¨®æ—ä¸å­˜æª”

        try {
            // æº–å‚™å­˜æª”è³‡æ–™
            const saveData = {
                player: {
                    ...Player,
                    // å°‡ Set è½‰æ›ç‚º Array ä»¥ä¾¿è½‰æˆ JSON
                    achievements: Array.from(Player.achievements),
                    history: {
                        items: Array.from(Player.history.items)
                    }
                },
                gameState: GameState,
                timestamp: new Date().toLocaleString()
            };
            // Encrypt save data
            const encrypted = btoa(encodeURIComponent(JSON.stringify(saveData)));
            localStorage.setItem('fantasy_adventure_save', encrypted);
        } catch (e) {
            console.error("Auto-save failed", e);
        }
    },

    loadGame() {
        const raw = localStorage.getItem('fantasy_adventure_save');
        if (!raw) return; // ç„¡å­˜æª”å‰‡ä¸åšä»»ä½•äº‹

        GameState.isLoading = true; // æ¨™è¨˜æ­£åœ¨è®€å–ï¼Œé¿å…è§¸ç™¼ updateUI ä¸­çš„å­˜æª”

        try {
            let json;
            try {
                // Try to decrypt
                json = decodeURIComponent(atob(raw));
            } catch (e) {
                // Fallback for legacy plaintext saves
                console.log("Legacy save detected or decryption failed, trying plain parse");
                json = raw;
            }

            const data = JSON.parse(json);
            // 1. é‚„åŸ Player è³‡æ–™
            Object.assign(Player, data.player);
            // å°‡ Array è½‰å› Set
            Player.achievements = new Set(data.player.achievements);
            Player.history.items = new Set(data.player.history.items);

            // 2. é‚„åŸ GameState
            Object.assign(GameState, data.gameState);
            // 3. é‚„åŸ UI èˆ‡ç‹€æ…‹
            this.updateUI();
            
            // éš±è—é¸æ“‡ç•«é¢
            document.getElementById('race-modal').style.display = 'none';
            document.getElementById('class-modal').style.display = 'none';
            
            // æ›´æ–°è·æ¥­èˆ‡ç¨®æ—å¾½ç« 
            const badgeMap = { 'knight': 'ğŸ›¡ï¸ é¨å£«', 'merchant': 'ğŸ’° å•†è²©', 'thief': 'ğŸ—¡ï¸ ç›œè³Š', 'cultist': 'ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’' };
            const raceMap = { 'elf': 'ğŸ§ ç²¾éˆ', 'demon': 'ğŸ‘¿ é­”æ—', 'human': 'ğŸ‘± äººé¡', 'orc': 'ğŸ‘¹ åŠç¸äºº' };
            document.getElementById('class-badge').innerText = badgeMap[Player.class] || "";
            document.getElementById('race-badge').innerText = raceMap[Player.race] || "";

            // 4. æ ¹æ“šç•¶å‰éšæ®µ(Phase)é‚„åŸç•«é¢
            if (GameState.phase === 'combat' && GameState.currentEnemy) {
                // å¦‚æœæ˜¯åœ¨æˆ°é¬¥ä¸­è®€æª”ï¼Œæ¢å¾©æˆ°é¬¥ç•«é¢
                const enemy = GameState.currentEnemy;
                this.renderEvent(`âš”ï¸ é­é‡ ${enemy.name} (æ¢å¾©)`, 
                    `HP: ${enemy.hp} | æ”»æ“Š: ${enemy.atk}`, 
                    "æˆ°é¬¥ç¹¼çºŒï¼", enemy.icon);
                let iconClass = "monster-icon";
                if(enemy.tier === "elite") iconClass += " monster-elite glow-blue";
                if(enemy.tier === "boss") iconClass += " monster-boss glow-red";
                if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";
                document.getElementById('event-icon').className = iconClass;
                
                this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", false);
            } 
            else if (GameState.phase === 'merchant') {
                // å¦‚æœæ˜¯åœ¨å•†åº—
                this.triggerAnim('event-icon', 'anim-spawn');
                this.renderEvent("ğŸ’° ç¥ç§˜å•†äºº", "æ­¡è¿å›ä¾†ï¼Œè¦ç¹¼çºŒäº¤æ˜“å—ï¼Ÿ", "é»æ“Šå•†å“å¯æŸ¥çœ‹è©³æƒ…èˆ‡è³¼è²·", "ğŸ‘³");
                this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
                this.renderMerchantShop();
            }
            else {
                // å…¶ä»–æƒ…æ³ (äº‹ä»¶çµæŸæˆ–å‰›é–‹å§‹)ï¼Œçµ±ä¸€å°å‘ã€Œç¹¼çºŒå†’éšªã€ç‹€æ…‹
                GameState.phase = "event_end";
                this.renderEvent("ğŸ“‚ è®€å–æˆåŠŸ", `æ­¡è¿å›åˆ°ç¬¬ ${Player.depth} å±¤`, "è«‹é»æ“ŠæŒ‰éˆ•ç¹¼çºŒå†’éšªã€‚", "ğŸ’¾");
                document.getElementById('event-icon').className = "monster-icon";
                document.getElementById('merchant-area').classList.add('hidden');
                this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            }

            this.showFloatingText("è‡ªå‹•è¼‰å…¥é€²åº¦", "#2196f3");
        } catch (e) {
            console.error(e);
            alert("å­˜æª”ææ¯€ï¼Œé–‹å§‹æ–°éŠæˆ²ã€‚");
            localStorage.removeItem('fantasy_adventure_save');
        } finally {
            GameState.isLoading = false;
        }
    },

    manualRestart() {
        if (confirm("âš  ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ\n\næŒ‰ä¸‹ç¢ºå®šå¾Œï¼Œç¾æœ‰çš„é€²åº¦å°‡æœƒè¢«åˆªé™¤ä¸”ç„¡æ³•å¾©åŸï¼")) {
            localStorage.removeItem('fantasy_adventure_save');
            location.reload();
        }
    },

    // --- Compendium ---
    getAllItems() {
        // Merge all item sources
        const items = [];
        // 1. Item Pool (Equipment, Potions)
        items.push(...CONFIG.itemPool);
        // 2. Loot Data (Materials, Boss Drops) - needs mapping
        for (let [name, data] of Object.entries(CONFIG.lootData)) {
            items.push({ ...data, name: name, type: 'material' }); // Ensure name is set
        }
        // 3. Phoenix Feather
        items.push(CONFIG.phoenixFeather);
        // Sort by Rarity then Name
        return items.sort((a, b) => {
            const rA = CONFIG.rarityDisplay[a.rarity].val;
            const rB = CONFIG.rarityDisplay[b.rarity].val;
            if (rA !== rB) return rA - rB;
            return a.name.localeCompare(b.name);
        });
    },

    showCompendium() {
        const modal = document.getElementById('compendium-modal');
        const list = document.getElementById('compendium-content');
        const stats = document.getElementById('compendium-stats');
        list.innerHTML = "";
        modal.style.display = 'flex';

        const allItems = this.getAllItems();
        const unlockedCount = allItems.filter(i => Player.history.items.has(i.name)).length;
        
        stats.innerText = `æ”¶é›†é€²åº¦: ${unlockedCount} / ${allItems.length}`;
        allItems.forEach(item => {
            const unlocked = Player.history.items.has(item.name);
            const div = document.createElement('div');
            
            // Special Handling for True Heart (Secret)
            if (!unlocked && item.name === "çœŸå¯¦ä¹‹å¿ƒ") {
                div.className = 'c-item secret-hidden';
                div.title = "?????";
                // Empty content for secret
            } 
            // Unlocked Items
            else if (unlocked) {
                div.className = `c-item unlocked ${CONFIG.rarityDisplay[item.rarity].color}`;
                div.title = this.getItemDesc(item) + `\n(åƒ¹å€¼: ${item.price}G)`;
                div.innerHTML = `
                    <div class="c-icon">${item.icon || 'ğŸ“¦'}</div>
                    <div class="c-name">${item.name}</div>
                `;
            } 
            // Locked Regular Items
            else {
                div.className = 'c-item unknown';
                div.title = "å°šæœªç²å¾—";
                div.innerHTML = `
                    <div class="c-icon">â“</div>
                    <div class="c-name">???</div>
                `;
            }
            list.appendChild(div);
        });
    },

    // --- Achievements ---
    checkAchievements() {
        let newUnlock = false;
        CONFIG.achievements.forEach(ach => {
            if (!Player.achievements.has(ach.id)) {
                if (ach.check(Player)) {
                    Player.achievements.add(ach.id);
                    this.showFloatingText(`ğŸ† é”æˆ: ${ach.name}`, CONFIG.rarityDisplay[ach.rarity].color === 'rarity-ultra' ? '#00ffcc' : 'gold');
                    newUnlock = true;
                }
            }
        });
        if (newUnlock) this.checkAchievements();
    },

    checkDrops(type) {
        let needed = [];
        CONFIG.monsters.forEach(m => {
            needed.push(m.drop);
            needed.push(m.eliteDrop);
            if (type === 'prospector') needed.push(m.bossDrop);
        });
        return needed.every(item => Player.history.items.has(item));
    },

    checkAllItems() {
        let allItems = [];
        CONFIG.itemPool.forEach(i => allItems.push(i.name));
        Object.keys(CONFIG.lootData).forEach(k => allItems.push(k));
        allItems.push(CONFIG.phoenixFeather.name);
        return allItems.every(i => Player.history.items.has(i));
    },

    checkTierComplete(tiers) {
        const targets = CONFIG.achievements.filter(a => tiers.includes(a.rarity) && !a.hidden);
        return targets.every(a => Player.achievements.has(a.id));
    },

    checkAllAchievements() {
        const others = CONFIG.achievements.filter(a => a.id !== 'true_rest');
        return others.every(a => Player.achievements.has(a.id));
    },

    showAchievements() {
        const modal = document.getElementById('achieve-modal');
        const list = document.getElementById('achieve-list-content');
        const stats = document.getElementById('achieve-stats');
        list.innerHTML = "";
        modal.style.display = 'flex';
        let visibleTotal = CONFIG.achievements.filter(a => !a.hidden || Player.achievements.has(a.id)).length;
        let unlockedCount = Player.achievements.size;
        
        stats.innerText = `é€²åº¦: ${unlockedCount} / ${visibleTotal}`;
        CONFIG.achievements.forEach(ach => {
            if (ach.hidden && !Player.achievements.has(ach.id)) return;

            const unlocked = Player.achievements.has(ach.id);
            const div = document.createElement('div');
            div.className = `achieve-item ${unlocked ? 'unlocked' : ''}`;
            
            let colorClass = CONFIG.rarityDisplay[ach.rarity].color;
            let rarityName = CONFIG.rarityDisplay[ach.rarity].label;

            div.innerHTML = `
                <div class="achieve-info">
                    <div class="achieve-name" style="${unlocked ? 'color:white' : ''}">${ach.name}</div>
                    <div class="achieve-cond">${ach.cond}</div>
                </div>
                <div class="achieve-badge ${colorClass}">${rarityName}</div>
            `;
            list.appendChild(div);
        });
    },

    // --- Core ---
    // [ä¿®æ”¹] é¸æ“‡ç¨®æ—å¾Œ -> è·³è½‰åˆ°æ€§åˆ¥
    selectRace(raceType) {
        Player.race = raceType;
        document.getElementById('race-modal').style.display = 'none';
        document.getElementById('gender-modal').style.display = 'flex'; // é¡¯ç¤ºæ€§åˆ¥é¸å–®

        const raceMap = { 'elf': 'ğŸ§ ç²¾éˆ', 'demon': 'ğŸ‘¿ é­”æ—', 'human': 'ğŸ‘± äººé¡', 'orc': 'ğŸ‘¹ åŠç¸äºº' };
        document.getElementById('race-badge').innerText = raceMap[raceType];
    },

    // [æ–°å¢] é¸æ“‡æ€§åˆ¥ -> è·³è½‰åˆ°æ€§å‘
    selectGender(genderType) {
        Player.gender = genderType;
        document.getElementById('gender-modal').style.display = 'none';
        document.getElementById('orientation-modal').style.display = 'flex';

        // æ€§åˆ¥æ•ˆæœè™•ç†
        if (genderType === 'male') Player.baseAtk += 10;
        if (genderType === 'female') { Player.maxHp += 40; Player.hp += 40; }
        // ç„¡æ€§åˆ¥èˆ‡éäºŒå…ƒåœ¨æˆ°é¬¥ä¸­è™•ç†
    },

    // [æ–°å¢] é¸æ“‡æ€§å‘ -> è·³è½‰åˆ°è·æ¥­
    selectOrientation(type) {
        Player.orientation = type;
        document.getElementById('orientation-modal').style.display = 'none';
        document.getElementById('class-modal').style.display = 'flex';
    },

    // [ä¿®æ”¹] è·æ¥­é¸æ“‡ (ç¶­æŒåŸæ¨£ï¼Œä½†ç¢ºèªå®ƒæœƒè¢«æœ€å¾Œå‘¼å«)
    selectClass(classType) {
        Player.class = classType;
        document.getElementById('class-modal').style.display = 'none';
        
        if (classType === 'knight') {
            const lance = { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" };
            this.addItemToInventory(lance, false); 
            this.equip(0, 'equipment');
        } else if (classType === 'cultist') {
            const demonBuffs = Object.values(CONFIG.buffs).filter(b => b.type === 'demon');
            Player.buff = demonBuffs[Math.floor(Math.random() * demonBuffs.length)];
            this.updateUI();
        } else {
            this.updateUI();
        }

        const badgeMap = { 'knight': 'ğŸ›¡ï¸ é¨å£«', 'merchant': 'ğŸ’° å•†è²©', 'thief': 'ğŸ—¡ï¸ ç›œè³Š', 'cultist': 'ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’' };
        document.getElementById('class-badge').innerText = badgeMap[classType];
        
        // é¡¯ç¤ºæ–°çš„å±¬æ€§åˆ° console æˆ– æç¤º (å¯é¸)
        this.log(`å±¬æ€§è¨­å®šå®Œæˆ: ${Player.gender} / ${Player.orientation}`);

        this.renderEvent("æº–å‚™å°±ç·’", "ä½ çš„å†’éšªå³å°‡é–‹å§‹...", "ç¥ä½ å¥½é‹ï¼", "âœ¨");
    },

    triggerAnim(id, animClass) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove(animClass);
            void el.offsetWidth;
            el.classList.add(animClass);
        }
    },

    showFloatingText(text, color, type = 'dmg-out') { // [ä¿®æ”¹] æ–°å¢ type åƒæ•¸ï¼Œé è¨­ç‚º dmg-out (ç©å®¶è¼¸å‡º/æ²»ç™‚)
        const display = document.getElementById('event-display');
        const div = document.createElement('div');
        div.className = `floating-text ${type}`; // æ‡‰ç”¨æ–°çš„é¡å‹
        div.innerHTML = text;
        div.style.color = color;
        display.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    },

    getAtk() {
        let atk = Player.baseAtk;
        if (Player.equipment.weapon) atk += Player.equipment.weapon.val;
        return atk;
    },

    /**
     * é‡æ–°è¨ˆç®— MaxHP ä¸¦æ ¹æ“šæ¯”ä¾‹èª¿æ•´ CurrentHP
     */
    recalcStats() {
        // 1. å„²å­˜ç•¶å‰è¡€é‡èˆ‡é­”åŠ›æ¯”ä¾‹ (ä»¥ä¾¿åœ¨ä¸Šé™æ”¹è®Šæ™‚ç¶­æŒç•¶å‰ç™¾åˆ†æ¯”ï¼Œæˆ–å–®ç´”ç¶­æŒæ•¸å€¼)
        const currentHpRatio = Player.maxHp > 0 ? Player.hp / Player.maxHp : 1;
        // é¸æ“‡æ–¹æ¡ˆï¼šé­”åŠ›é€šå¸¸æ˜¯ç¶­æŒæ•¸å€¼ä¸è®Šï¼Œè€Œä¸æ˜¯ç¶­æŒæ¯”ä¾‹ï¼Œé€™è£¡æˆ‘å€‘ç¶­æŒç•¶å‰æ•¸å€¼
        // å¦‚æœæ‚¨å¸Œæœ›å‡ç´šæ™‚é­”åŠ›ä¹Ÿè‡ªå‹•è£œæ»¿æ¯”ä¾‹ï¼Œå¯ä»¥åƒè€ƒ HP çš„åšæ³•

        // 2. è¨ˆç®—æ–°çš„ MaxHP (ä¿æŒåŸæœ¬é‚è¼¯)
        let bonusHp = Player.equipment.armor ? Player.equipment.armor.val : 0;
        const genderHp = Player.gender === 'female' ? 40 : 0; 
        const newMaxHp = 100 + bonusHp + genderHp;
        Player.maxHp = newMaxHp;
        
        // 3. æ›´æ–°ç•¶å‰ HP (ä¿æŒåŸæœ¬é‚è¼¯)
        let newHp = Math.round(currentHpRatio * Player.maxHp);
        Player.hp = Math.min(newHp, Player.maxHp);
        if (Player.hp < 0) Player.hp = 0;

        // ==========================================
        // [æ–°å¢] MaxMP æˆé•·æ©Ÿåˆ¶
        // ==========================================
        // åŸºç¤é­”åŠ› 120 + æ¯å±¤å¢åŠ  1 é»ä¸Šé™
        const baseMp = 120;
        const depthBonus = Player.depth * 1; 
        
        // æ‚¨ä¹Ÿå¯ä»¥åœ¨é€™è£¡åŠ å…¥è£å‚™åŠ æˆ (å¦‚æœæœªä¾†æœ‰åŠ é­”åŠ›çš„è£å‚™)
        // let equipMp = ...
        
        Player.maxMp = baseMp + depthBonus;

        // ç¢ºä¿ç•¶å‰é­”åŠ›ä¸è¶…éæ–°çš„ä¸Šé™
        if (Player.mp > Player.maxMp) {
            Player.mp = Player.maxMp;
        }
        // ==========================================
        
        this.updateStatsUI();
    },
	nextEvent() {
        if (Player.hp <= 0) {
            this.restart();
            return;
        }

        Player.depth++;

        // ==========================================
        // 1. [é—œéµæ–°å¢] éå±¤å¾Œç«‹å³é‡æ–°è¨ˆç®—å±¬æ€§
        // é€™æœƒè§¸ç™¼ recalcStatsï¼Œè®“ MaxMP = 100 + å±¤æ•¸
        // ==========================================
        this.recalcStats(); 

        // ==========================================
        // 2. éå±¤å›é­” (å›ºå®š +5) - ç¶­æŒæ‚¨åŸæœ¬çš„å»¶é²æ•ˆæœ
        // ==========================================
        if (Player.mp < Player.maxMp) {
            let mpRegen = 5; 
            setTimeout(() => {
                if (Player.hp <= 0 || GameState.phase === 'dead') return;
                
                // é€™è£¡æœƒæ ¹æ“šæ–°çš„ MaxMP é€²è¡Œè£œé­”
                Player.mp = Math.min(Player.maxMp, Player.mp + mpRegen);
                
                this.showFloatingText(`+${mpRegen} MP`, "#2196f3", 'dmg-out');
                this.updateUI();
            }, 150);
        }

        this.checkAchievements();
        this.log(`>>> é€²å…¥ç¬¬ ${Player.depth} å±¤æ¢ç´¢...`);

        // ==========================================
        // 3. ç²¾éˆè¢«å‹•èˆ‡äº‹ä»¶é‚è¼¯ (ä¿æŒåŸæ¨£)
        // ==========================================
        
        // [ç²¾éˆå›è¡€]
        if (GameState.skipNextRegen) {
            GameState.skipNextRegen = false;
        } else {
            if (Player.race === 'elf' || (Player.buff && Player.buff.id === 'angel_song')) {
                let healAmount = 0;
                if (Player.race === 'elf') healAmount += Math.floor(Player.maxHp * 0.05);
                if (Player.buff && Player.buff.id === 'angel_song') healAmount += 20;
                
                if (Player.hp < Player.maxHp) {
                    // å»¶é² 0.3 ç§’å›è¡€
                    setTimeout(() => {
                        if (Player.hp <= 0 || GameState.phase === 'dead') return;
                        Player.hp = Math.min(Player.maxHp, Player.hp + healAmount);
                        this.showFloatingText(`+${healAmount} HP`, "#69f0ae");
                        this.updateUI();
                    }, 300);
                }
            }
        }

        // [äº‹ä»¶æ©Ÿç‡åˆ¤æ–·]
        if (Player.depth >= 1000 && (Player.depth - 1000) % 500 === 0) {
            this.triggerCombat(true, true);
            this.updateUI();
            return;
        }

        if (Player.depth === 500) {
            this.triggerCombat(true, false);
            this.updateUI();
            return;
        }
        
        if (Player.depth === 501) {
            alert("è­¦å‘Šï¼šä½ å·²é€²å…¥æ·±å±¤é ˜åŸŸï¼æ‰€æœ‰æ€ªç‰©å¯¦åŠ›å¤§å¹…å¢å¼·ï¼");
        }

        if (Player.depth > 200 && Math.random() < 0.01) {
            this.triggerHarpy();
            this.updateUI();
            return;
        }

        const rand = Math.random();
        // Probabilities: Heal 5%, Statue 5%, Class 3%, Merchant 17%, Chest 10%, Combat 60%
        if (rand < 0.05) {
            this.triggerHeal();
        } else if (rand < 0.10) {
            this.triggerStatue();
        } else if (rand < 0.13) {
            this.triggerClassEvent();
        } else if (rand < 0.30) {
            this.triggerMerchant();
        } else if (rand < 0.40) {
            this.triggerChest();
        } else {
            this.triggerCombat(false, false);
        }
        
        this.updateUI();
    },

    triggerClassEvent() {
        GameState.phase = "event_end";
        if (Player.class === 'knight') this.handleKnightEvent();
        else if (Player.class === 'merchant') this.handleMerchantEvent();
        else if (Player.class === 'thief') this.handleThiefEvent();
        else if (Player.class === 'cultist') this.handleCultistEvent();
    },

    handleKnightEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("âš”ï¸ é¨å£«çš„è·è²¬", "ç™¼ç¾ä¸€ç¾¤è¢«æ€ªç‰©åŒ…åœçš„æ¢éšªè€…...", "æ˜¯å¦å‡ºæ‰‹ç›¸åŠ©ï¼Ÿ", "ğŸ›¡ï¸");
        this.setButtons("å¹«åŠ© (60%å‹)", "resolveKnightHelp", "ç„¡è¦–", "nextEvent", false);
    },

    resolveKnightHelp() {
        if (Math.random() < 0.6) {
            Player.gold += 100;
            this.showFloatingText("+100 G", "gold");
            this.renderEvent("âš”ï¸ æ•‘æ´æˆåŠŸ", "ä½ æˆåŠŸæ“Šé€€äº†æ€ªç‰©ï¼", "ç²å¾—å ±é…¬ <span class='gold-text'>100 G</span>", "ğŸ‰");
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent("âš”ï¸ æ•‘æ´å¤±æ•—", "æ€ªç‰©å¤ªå¼·äº†ï¼Œä½ å—äº†é‡å‚·...", `æå¤± <span class='damage-text'>${dmg} HP</span>`, "ğŸ©¸");
            if (Player.hp <= 0) { this.playerDie("æ­»æ–¼æ•‘æ´è¡Œå‹•"); return; }
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    handleMerchantEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("âš–ï¸ é»‘å¸‚äº¤æ˜“", "é‡åˆ°ä¸€åå¯ç–‘çš„é»‘å¸‚å•†äººã€‚", "èŠ±è²» 66 G è³¼è²·ç¥ç§˜ç‰©å“ï¼Ÿ(10% è¢«é¨™)", "ğŸ•µï¸");
        this.setButtons("äº¤æ˜“ (66 G)", "resolveMerchantTrade", "é›¢é–‹", "nextEvent", false);
    },

    resolveMerchantTrade() {
        if (Player.gold < 66) { alert("é‡‘å¹£ä¸è¶³ï¼"); return; }
        Player.gold -= 66;
        this.showFloatingText("-66 G", "gold");
        if (Math.random() < 0.1) {
            this.renderEvent("ğŸ’¸ è¢«é¨™äº†ï¼", "å•†äººæ‹¿äº†éŒ¢å°±è·‘äº†ï¼", "ä½ ä»€éº¼éƒ½æ²’å¾—åˆ°ã€‚", "ğŸ’¨");
        } else {
            let item;
            if (Math.random() < 0.02) { // ç¨å¾®æé«˜ä¸€é»é»æ©Ÿç‡
                const legends = CONFIG.itemPool.filter(i => i.rarity === 'legendary' || i.rarity === 'epic');
                item = { ...legends[Math.floor(Math.random() * legends.length)] };
            } else {
                item = this.generateSpecificItem(['weapon', 'armor', 'shield', 'consumable']);
            }
            this.addItemToInventory(item);
            this.renderEvent("âš–ï¸ äº¤æ˜“æˆåŠŸ", "ä½ ç²å¾—äº†ä¸€å€‹ç¥ç§˜åŒ…è£¹...", `ç²å¾— <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, "ğŸ");
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    handleThiefEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—ï¸ é‡‘è‰²å¯¶ç®±", "é è™•ç™¼ç¾ä¸€å€‹æ•£ç™¼å…‰èŠ’çš„å¯¶ç®±...", "å˜—è©¦æ‰“é–‹ï¼Ÿ(5% ç²å¾—ç¥å™¨)", "âœ¨");
        this.setButtons("æ‰“é–‹", "resolveThiefChest", "é›¢é–‹", "nextEvent", false);
    },

    resolveThiefChest() {
        if (Math.random() < 0.05) { 
            
            let finalRarity;
            const r = Math.random();
            if (r < 0.10) {
                finalRarity = 'ultra';
            } else if (r < 0.35) {
                finalRarity = 'mythic';
            } else {
                finalRarity = 'legendary';
            }
            
            let rewardPool = CONFIG.itemPool.filter(i => 
                i.rarity === finalRarity && ['weapon', 'armor', 'shield'].includes(i.type)
            );

            if (rewardPool.length === 0) {
                rewardPool = CONFIG.itemPool.filter(i => i.rarity === finalRarity);
            }
            
            if (rewardPool.length === 0) {
                const fallbackItem = CONFIG.itemPool[Math.floor(Math.random() * CONFIG.itemPool.length)];
                rewardPool.push(fallbackItem);
            }

            const rewardTemplate = rewardPool[Math.floor(Math.random() * rewardPool.length)];
            const item = Object.assign({}, rewardTemplate);
            
            this.addItemToInventory(item);
            
            this.renderEvent("âœ¨ å‚³èªªç¾ä¸–", 
                             "å¯¶ç®±è£¡ç«Ÿç„¶æ˜¯é ‚ç´šç¥å™¨ï¼", 
                             `ç²å¾— <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, 
                             "ğŸ‘‘");
        
        } else {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield', 'consumable']);
            this.addItemToInventory(item);
            this.renderEvent("ğŸ“¦ ç²å¾—ç‰©å“", "å¯¶ç®±é›–ç„¶æ²’æœ‰ç¥å™¨ï¼Œä½†è£¡é¢é‚„æœ‰ä¸€å€‹æ™®é€šç‰©å“ã€‚", `ç²å¾— <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, "ğŸ“¦");
        }

        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    handleCultistEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ² æƒ¡é­”çš„éŠæˆ²", "æƒ¡é­”é‚€è«‹ä½ ç©æ¯”å¤§å°...", "è´å¾—ç¨€æœ‰è£å‚™ï¼Œè¼¸äº†å‰© 1% è¡€é‡ã€‚", "ğŸ˜ˆ");
        this.setButtons("æ¥å—æŒ‘æˆ°", "resolveCultistGame", "æ‹’çµ•", "nextEvent", false);
    },

    resolveCultistGame() {
        const pRoll = Math.floor(Math.random() * 6) + 1;
        const dRoll = Math.floor(Math.random() * 6) + 1;
        
        let resultHtml = `ä½ æ“²å‡ºäº† ${pRoll}ï¼Œæƒ¡é­”æ“²å‡ºäº† ${dRoll}ã€‚<br>`;
        if (pRoll > dRoll) {
            let rarity = 'rare';
            let r = Math.random();
            if (r < 0.1) rarity = 'legendary';
            else if (r < 0.3) rarity = 'epic';
            let pool = CONFIG.itemPool.filter(i => i.rarity === rarity && ['weapon', 'armor', 'shield'].includes(i.type));
            if (pool.length === 0) pool = CONFIG.itemPool.filter(i => i.rarity === 'rare');
            
            const item = { ...pool[Math.floor(Math.random() * pool.length)] };
            this.addItemToInventory(item);
            this.renderEvent("ğŸ² å‹åˆ©ï¼", resultHtml, `æƒ¡é­”ä¸ç”˜å¿ƒåœ°çµ¦äº†ä½  <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, "ğŸ‰");
        } else {
            Player.hp = Math.floor(Player.maxHp * 0.01) || 1;
            this.showFloatingText("HP -> 1%", "darkred");
            this.renderEvent("ğŸ² å¤±æ•—...", resultHtml, "æƒ¡é­”å¥ªèµ°äº†ä½ çš„ç”Ÿå‘½åŠ›...", "ğŸ’€");
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    triggerHarpy() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        let outcome = Math.random();
        let title = "ğŸ¦… é­é‡å“ˆæ¯”";
        let desc = "";
        let icon = "ğŸ¦…";
        if (outcome < 0.2) {
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            desc = "ä½ æˆåŠŸæ“Šé€€äº†å“ˆæ¯”ï¼Œæ’¿åˆ°äº†å®ƒæ‰è½çš„ <span class='gold-text'>500 G</span>ï¼";
        } else {
            const type = Math.floor(Math.random() * 4);
            if (type === 0) {
                Player.inventory.equipment = [];
                desc = "å“ˆæ¯”æ¶èµ°äº†ä½ èƒŒåŒ…è£¡æ‰€æœ‰çš„ <span class='damage-text'>è£å‚™</span>ï¼";
            } else if (type === 1) {
                
                let keptConsumables = []; // ç”¨æ–¼å­˜æ”¾æœªè¢«å·èµ°çš„æ¶ˆè€—å“
                let stolenCount = 0;
                
                Player.inventory.consumable.forEach(item => {
                    // åˆ¤æ–·ç‰©å“æ˜¯å¦ç‚ºã€Œå…¨èƒ½è—¥æ°´ã€
                    if (item.name === "å…¨èƒ½è—¥æ°´") {
                        keptConsumables.push(item); // [ä¿è­·] ä¸æ”¾å…¥è¢«å·èµ°çš„æ¸…å–®
                    } else {
                        stolenCount++;
                    }
                });
                
                Player.inventory.consumable = keptConsumables; // è¨­ç½®æ–°çš„æ¶ˆè€—å“åˆ—è¡¨
                
                if (stolenCount > 0) {
                    desc = `å“ˆæ¯”æ¶èµ°äº†ä½ èƒŒåŒ…è£¡ <span class='damage-text'>${stolenCount} ä»¶æ¶ˆè€—å“</span>ï¼`;
                    if (keptConsumables.length > 0) {
                        desc += `<br>(ä½†å¹¸é‹åœ°ä¿ä½äº†é‡è¦çš„è—¥åŠ‘!)`;
                    }
                } else {
                    desc = "å“ˆæ¯”è©¦åœ–å·èµ°ä½ çš„æ¶ˆè€—å“ï¼Œä½†ä½ åªæ”œå¸¶äº†é‡è¦çš„è—¥åŠ‘ï¼ŒæˆåŠŸä¿ä½ï¼";
                }
                
            } else if (type === 2) {
                
                let keptMaterials = []; // ç”¨æ–¼å­˜æ”¾æœªè¢«å·èµ°çš„ç´ æ
                let stolenCount = 0;
                
                Player.inventory.material.forEach(item => {
                    // åˆ¤æ–·ç‰©å“æ˜¯å¦ç‚ºã€Œä¸æ­»é³¥çš„ç¾½æ¯›ã€
                    if (item.name === "ä¸æ­»é³¥çš„ç¾½æ¯›") {
                        keptMaterials.push(item); // [ä¿è­·] ä¿ç•™ä¸æ­»é³¥çš„ç¾½æ¯›
                    } else {
                        stolenCount++;
                    }
                });
                
                Player.inventory.material = keptMaterials; // è¨­ç½®æ–°çš„ç´ æåˆ—è¡¨
                
                if (stolenCount > 0) {
                    desc = `å“ˆæ¯”æ¶èµ°äº†ä½ èƒŒåŒ…è£¡ <span class='damage-text'>${stolenCount} ä»¶ç´ æ</span>ï¼`;
                    if (keptMaterials.length > 0) {
                        desc += `<br>(ä½ é©šéšªåœ°ä¿ä½äº†ä¸æ­»é³¥çš„ç¾½æ¯›!)`;
                    }
                } else {
                    desc = "å“ˆæ¯”è©¦åœ–å·èµ°ç´ æï¼Œä½†ä½ åªæ”œå¸¶äº†çè²´çš„ç¾½æ¯›ï¼ŒæˆåŠŸä¿ä½ï¼";
                }
                
            } else {

                Player.gold = 0;
                desc = "å“ˆæ¯”æ¶èµ°äº†ä½ èº«ä¸Šæ‰€æœ‰çš„ <span class='damage-text'>é‡‘å¹£</span>ï¼";
            }
        }
        
        this.renderEvent(title, "ä¸€éš»å“ˆæ¯”çªç„¶å¾ç©ºä¸­è¥²ä¾†ï¼", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    triggerHeal() {
        const oldHp = Player.hp;
        Player.hp = Player.maxHp; 
        const healed = Player.hp - oldHp;
        
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’– ä¼‘æ¯æ™‚åˆ»", "ä½ æ‰¾åˆ°ä¸€è™•å®‰å…¨çš„åœ°æ–¹ä¼‘æ¯ã€‚", `ç”Ÿå‘½å€¼ <span class='heal-text'>å®Œå…¨æ¢å¾©</span> (æ¢å¾©äº† ${healed} é»)ã€‚`, "ğŸ›Œ");
        if(healed > 0) this.showFloatingText(`+${healed} HP`, "#69f0ae");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    triggerStatue() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—¿ ç¥ˆç¦±è–åƒ", "ä½ ç™¼ç¾äº†ä¸€åº§å¤è€çš„è–åƒ...", "æ˜¯å¦è¦é€²è¡Œç¥ˆç¦±ï¼Ÿ", "ğŸ™");
        this.setButtons("ç¥ˆç¦±", "pray", "é›¢é–‹", "nextEvent", false);
    },

    pray() {
        if (!CONFIG.buffs) return;
        const isAngel = Math.random() < 0.5;
        const type = isAngel ? 'angel' : 'demon';
        const icon = isAngel ? "ğŸ‘¼" : "ğŸ˜ˆ";
        const options = Object.values(CONFIG.buffs).filter(b => b.type === type);
        
        if (options.length === 0) return;
        const selected = options[Math.floor(Math.random() * options.length)];
        Player.buff = selected;
        
        let title = isAngel ? "å¤©ä½¿è–åƒ" : "æƒ¡é­”è–åƒ";
        let style = isAngel ? "angel-text" : "demon-text";
        
        this.triggerAnim('event-icon', 'anim-spawn');
        let desc = `ä½ ç²å¾—äº† <span class='${style}'>${selected.name}</span> çš„æ•ˆæœã€‚<br><small>${selected.desc}</small>`;
        this.renderEvent(title, "ç¥ˆç¦±å¾—åˆ°äº†å›æ‡‰...", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    triggerMerchant() {
        GameState.phase = "merchant";
        Player.dailyRefreshCount = 0; 
        // ----------------------------------------
        
        this.generateMerchantStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’° ç¥ç§˜å•†äºº", "ã€Œç´ æå¯æ˜¯å¾ˆå€¼éŒ¢çš„ï¼Œè¦è³£ä¸€äº›å—ï¼Ÿã€", "é»æ“Šå•†å“å¯æŸ¥çœ‹è©³æƒ…èˆ‡è³¼è²·", "ğŸ‘³");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.renderMerchantShop();
    },

    generateMerchantStock() {
        GameState.merchantStock = [];
        const stockSize = 12; // ç¶­æŒ 12 æ ¼
        
        // 1. æ±ºå®šæ˜¯å¦è¦åŠ å…¥éš±è—è³­å±€
        let wagerIndex = -1;
        let shouldTrigger = false;

        if (!Player.hasTriggeredHiddenWager) {
            shouldTrigger = true; // ç¬¬ä¸€æ¬¡é‡åˆ°å•†äººï¼Œå¿…å®šè§¸ç™¼
        } else if (Math.random() < 0.03) {
            shouldTrigger = true; // ä¹‹å¾Œæœ‰ 3% æ©Ÿç‡è§¸ç™¼
        }

        if (shouldTrigger) {
            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹ä½ç½® (0 åˆ° 11) æ”¾ç½®æŠ½çæ©Ÿæœƒ
            wagerIndex = Math.floor(Math.random() * stockSize); 
        }

        // 2. ç”Ÿæˆå•†å“åˆ—è¡¨ (12å€‹)
        for(let i = 0; i < stockSize; i++) {
            if (i === wagerIndex) {
                // åœ¨é¸å®šçš„ä½ç½®æ”¾ç½®ä¸€å€‹ç‰¹æ®Šçš„ã€ä¸å¯è³¼è²·çš„ä½”ä½ç¬¦
                // å‘½åç‚ºã€Œç¥ç§˜çš„å¤ç±ã€ä»¥è§¸ç™¼ buyItem è£¡çš„æ–°é‚è¼¯
                GameState.merchantStock.push({ 
                    name: "ç¥ç§˜çš„å¤ç±", 
                    type: "wager_trigger", 
                    price: 9999, // é«˜åƒ¹é¿å…èª¤é»
                    rarity: "mythic", 
                    icon: "ğŸ“œ", 
                    desc: "ç„¡æ³•å®šåƒ¹çš„å¤ç±ï¼Œä¼¼ä¹æœ‰å¼·å¤§é­”åŠ›..."
                });
            } else {
                GameState.merchantStock.push(this.generateRandomItem());
            }
        }
    },

    getItemDesc(item) {
        if (item.desc) return item.desc;
        if (item.type === 'weapon') return `æ”»æ“ŠåŠ› +${item.val}`;
        if (item.type === 'armor') return `ç”Ÿå‘½ä¸Šé™ +${item.val}`;
        if (item.type === 'shield') return `æŠµæ“‹ ${item.val} æ¬¡æ”»æ“Š`;
        if (item.type === 'loot') return `æˆ°åˆ©å“ (å¯é«˜åƒ¹å‡ºå”®)`;
        return "æœªçŸ¥ç‰©å“";
    },

   renderMerchantShop() {
        const area = document.getElementById('merchant-area');
        area.innerHTML = "";
        area.classList.remove('hidden');
        
        // 1. è¨ˆç®—æœ€å¤§åˆ·æ–°æ¬¡æ•¸
        let maxRefreshes = 1; // åŸºç¤ 1 æ¬¡ (0-100 å±¤)
        if (Player.depth > 100) maxRefreshes = 2; // 101-300 å±¤ 2 æ¬¡
        if (Player.depth > 300) maxRefreshes = 3; // 301 å±¤ä»¥ä¸Š 3 æ¬¡
        
        const remaining = maxRefreshes - Player.dailyRefreshCount;
        
        // 2. æ¸²æŸ“è³¼è²·å€
        let buyHtml = "<h4>è³¼è²·å•†å“</h4><div class='merchant-grid'>";
        GameState.merchantStock.forEach((item, idx) => {
            if (!item) {
                 // ä½”ä½ç¬¦ï¼Œä¿æŒæ’ç‰ˆ
                 buyHtml += `<div class="merchant-item" style="opacity:0; pointer-events:none;"></div>`;
                 return;
            }
         
            const desc = this.getItemDesc(item);
            const rarityColor = CONFIG.rarityDisplay[item.rarity].color;
            
            // é¡¯ç¤ºæ‰“æŠ˜åƒ¹æ ¼
            let displayPrice = item.price;
            let priceClass = "gold-text";
            if (Player.orientation === 'homo') {
                displayPrice = Math.floor(item.price * 0.9);
                priceClass = "heal-text";
            }

            buyHtml += `<div class="merchant-item ${rarityColor}" onclick="Game.buyItem(${idx})">
                <div class="m-top">
                    <span>${item.icon || 'ğŸ“¦'} ${item.name}</span>
                    <span class="${priceClass}">${displayPrice} G</span>
                </div>
                <div class="m-desc">${desc}</div>
            </div>`;
        });
        buyHtml += "</div>";
        
        // 3. æ¸²æŸ“å‡ºå”®å€å’Œåˆ·æ–°æŒ‰éˆ• (é€™æ˜¯ç¼ºå¤±çš„éƒ¨åˆ†)
        buyHtml += `<div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <h4>å‡ºå”®</h4>
            <button onclick="Game.sellAllMaterials()" style="padding:5px 10px; font-size:0.8em; background:#d32f2f;">ä¸€éµå‡ºå”®ç´ æ</button>
        </div>
        
        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <h4>å•†åº—åˆ·æ–°</h4>
            <button onclick="Game.refreshMerchant()" ${remaining <= 0 ? 'disabled' : ''} style="padding:5px 10px; font-size:0.9em; background:#00bcd4;">
                ğŸ”„ åˆ·æ–° (${remaining} / ${maxRefreshes})
            </button>
        </div>
        
        <p style='font-size:0.8em; color:#888'>é»æ“Šä¸‹æ–¹èƒŒåŒ…ç‰©å“å³å¯å‡ºå”®ã€‚</p>`;
        
        area.innerHTML = buyHtml;
    },
   buyItem(idx) {
        let item = GameState.merchantStock[idx];
        if (!item) return;

        // ==========================================
        // [ä¿®æ”¹] éš±è—æ©Ÿåˆ¶ï¼šåˆ¤æ–·æ˜¯å¦é»æ“Šåˆ°ç‰¹æ®Šçš„æŠ½çå•†å“
        // ==========================================
        if (item.type === 'wager_trigger') {
            
            // æ¨™è¨˜å·²è§¸ç™¼ (å³ä½¿å¤±æ•—ï¼Œä¸‹æ¬¡ä¹Ÿåªæœƒæ˜¯æ©Ÿç‡è§¸ç™¼)
            Player.hasTriggeredHiddenWager = true; 

            // 1. æª¢æŸ¥èº«ä¸Šæ˜¯å¦æœ‰éŒ¢ (0å…ƒç„¡æ³•åƒåŠ )
            if (Player.gold <= 0) {
                alert("å•†äººï¼šã€Œæ²’éŒ¢é‚„æƒ³ä¾†ç¢°é‹æ°£ï¼Ÿå»å»å»ï¼ã€");
                return;
            }

            // 2. è·³å‡ºè©¢å•è¦–çª—
            let cost = Player.gold;
            let confirmMsg = `ğŸ° ã€ç¥ç§˜æŠ½çã€‘\n\nå•†äººçªç„¶æ””ä½äº†ä½ ...` +
                             `\nã€Œå®¢å®˜ï¼Œé€™ä»¶å•†å“æ˜¯éè³£å“ã€‚ä½†çœ‹ä½ æœ‰ç·£ï¼Œè¦ä¸è¦è³­ä¸€æŠŠï¼Ÿã€\n\n` +
                             `ä»£åƒ¹ï¼šæ¢­å“ˆï¼(èŠ±è²»èº«ä¸Šæ‰€æœ‰é‡‘å¹£: ${cost} G)\n` +
                             `çå“ï¼šå‚³èªªä¸­çš„å¦–åˆ€\n` +
                             `æ©Ÿç‡ï¼š1%  \n\n` +
                             `è¦è³­ä¸Šä¸€åˆ‡å—ï¼Ÿ`;
            if (!confirm(confirmMsg)) {
                return; // ç©å®¶å–æ¶ˆ
            }

            // 3. æ‰£é™¤æ‰€æœ‰é‡‘éŒ¢
            Player.gold = 0;
            this.showFloatingText(`-${cost} G (æ¢­å“ˆ)`, "red");

	    // 4. è¨ˆç®—ä¸­ççµæœ (ç§»é™¤å¤©é¸ä¹‹äººè¨­å®šï¼Œæ‰€æœ‰ç©å®¶çµ±ä¸€æ©Ÿç‡)
	    let isWin = false;

	    // æ‰€æœ‰ç©å®¶éƒ½åªæœ‰ 1% æ©Ÿç‡ä¸­ç (å¯åœ¨æ­¤è™•èª¿æ•´æ©Ÿç‡)
	    if (Math.random() < 0.01) { // 0.01 ä»£è¡¨ 1%
    	        isWin = true;
	    }

            // 5. çµç®—
            if (isWin) {
                // ä¸­çï¼šçµ¦äºˆå¦–åˆ€
                const hiddenItem = CONFIG.itemPool.find(i => i.name === "å¦–åˆ€æ‘æ­£");
                // å¦‚æœæ‰¾ä¸åˆ°è¨­å®šæª”(é˜²å‘†)ï¼Œæ‰‹å‹•å»ºç«‹
                const reward = hiddenItem ?
                { ...hiddenItem } : { name: "å¦–åˆ€æ‘æ­£", type: "weapon", val: 500, rarity: "ultra", price: 15000, icon: "ğŸ—¡ï¸", desc: "å—è©›å’’çš„å¦–åˆ€ï¼Œ+20% æš´æ“Šç‡" };
                this.addItemToInventory(reward);
                GameState.merchantStock[idx] = null; // ç§»é™¤è©²æ ¼å•†å“

                this.renderEvent("ğŸ° è³­ç¥é™è‡¨ï¼", 
                    "å•†äººé©šè¨å¾—ä¸‹å·´éƒ½æ‰ä¸‹ä¾†äº†...", 
                    "æ­å–œä½ è´å¾—äº†å‚³èªªç¥å™¨ <span class='rarity-ultra'>å¦–åˆ€æ‘æ­£</span>ï¼", 
                    "ğŸ‰");
                alert("å¤©å•Šï¼ä½ çœŸçš„ä¸­çäº†ï¼ç²å¾—ã€Œå¦–åˆ€æ‘æ­£ã€ï¼");
            } else {
                // æ²’ä¸­ï¼šéŒ¢æ²’äº†ï¼Œå•†å“ä¹Ÿæ²’äº†
                GameState.merchantStock[idx] = null; // ç§»é™¤è©²æ ¼å•†å“è¡¨ç¤ºåˆ¸ç”¨æ‰äº†
                
                this.renderEvent("ğŸ’¸ éŠ˜è¬æƒ é¡§", 
                    "å•†äººé–‹å¿ƒåœ°æ”¶ä¸‹äº†ä½ æ‰€æœ‰çš„è²¡ç”¢ã€‚", 
                    "å¾ˆéºæ†¾ï¼Œä½ ä»€éº¼éƒ½æ²’æŠ½åˆ°ã€‚å£è¢‹ç©ºç©º...", 
                    "ğŸ˜­");
                alert("ä»€éº¼éƒ½æ²’ç™¼ç”Ÿ... ä½ çš„éŒ¢éƒ½æ²’äº†ã€‚");
            }

            this.updateUI();
            this.renderMerchantShop();
            return; // çµæŸï¼Œä¸åŸ·è¡Œä¸‹æ–¹çš„ä¸€èˆ¬è³¼è²·é‚è¼¯
        }

        // ==========================================
        // ä»¥ä¸‹ç‚ºä¸€èˆ¬è³¼è²·é‚è¼¯ (åŒ…å«åŒæ€§æˆ€å„ªæƒ )
        // ==========================================
        
        // è¨ˆç®—å¯¦éš›åƒ¹æ ¼ (åŒæ€§æˆ€æ‰“9æŠ˜)
        let finalPrice = item.price;
        if (Player.orientation === 'homo') {
            finalPrice = Math.floor(finalPrice * 0.9);
        }

        if (Player.gold >= finalPrice) {
            Player.gold -= finalPrice;
            this.addItemToInventory(item);
            GameState.merchantStock[idx] = null; // è³¼è²·å¾Œæ¸…ç©ºè©²æ ¼
            
            this.showFloatingText("- " + finalPrice + " G", "yellow");
            
            if (Player.orientation === 'homo') this.log(`è³¼è²·äº† ${item.name} (åŒæ€§æˆ€å„ªæƒ )`);
            else this.log(`è³¼è²·äº† ${item.name}`);
            
            this.updateUI();
            this.renderMerchantShop();
        } else {
            alert("é‡‘å¹£ä¸è¶³ï¼" + (Player.orientation === 'homo' ? " (å·²æ‰“æŠ˜)" : ""));
        }
    },

    sellAllMaterials() {
        if (GameState.phase !== "merchant") return;
        if (Player.inventory.material.length === 0) {
            alert("æ²’æœ‰å¯å‡ºå”®çš„ç´ æã€‚");
            return;
        }
        
        let total = 0;
        let keptItems = [];
        Player.inventory.material.forEach(item => {
            if (item.type === 'revive') {
                keptItems.push(item);
            } else {
                let price = item.price; 
                if (Player.class === 'merchant') price = Math.floor(price * 1.2);
                total += price;
            }
        });
        Player.inventory.material = keptItems;
        Player.gold += total;
	this.showFloatingText(`+${total} G`, "yellow", 'dmg-in');
        this.log(`å‡ºå”®äº†æ‰€æœ‰ç´ æï¼Œç²å¾— ${total} G`);
        this.updateUI();
    },

	// [ä¿®æ”¹] å‡ºå”®ç‰©å“ (æ”¯æ´å †ç–Šæ‰£é™¤)
    sellItem(index, category) {
        if (GameState.phase !== "merchant") return;
        const item = Player.inventory[category][index];
        if (!item) return;
        if (item.type === 'revive') {
            alert("é€™ä»¶ç‰©å“å¤ªçè²´äº†ï¼Œç„¡æ³•å‡ºå”®ï¼");
            return;
        }

        let price = item.price;
        if (['weapon', 'armor', 'shield', 'consumable'].includes(item.type)) {
            price = Math.floor(price * 0.8);
        }
        if (Player.class === 'merchant') {
            price = Math.floor(price * 1.2);
        }
        
        if(confirm(`ç¢ºå®šè¦ä»¥ ${price} G å‡ºå”® ${item.name} å—ï¼Ÿ`)) {
            Player.gold += price;
            
            // [é‡é»] æ‰£é™¤æ•¸é‡
            if (item.count > 1) {
                item.count--;
            } else {
                Player.inventory[category].splice(index, 1);
            }

            this.showFloatingText("+ " + price + " G", "yellow");
            this.log(`å‡ºå”® ${item.name} ç²å¾— ${price} G`);
            this.updateUI();
        }
    },

    refreshMerchant() {
        let maxRefreshes = 1;
        if (Player.depth > 100) maxRefreshes = 2;
        if (Player.depth > 300) maxRefreshes = 3;
        
        if (Player.dailyRefreshCount < maxRefreshes) {
            Player.dailyRefreshCount++;
            this.generateMerchantStock();
            this.renderMerchantShop();
            this.showFloatingText(`å•†åº—å·²åˆ·æ–°ï¼`, "#00bcd4");
            this.updateUI();
        } else {
            alert("ä»Šæ—¥åˆ·æ–°é¡åº¦å·²ç”¨å®Œï¼");
        }
    },

    triggerChest() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');

        if (Math.random() < 0.01) {
            const feather = {...CONFIG.phoenixFeather};
            this.addItemToInventory(feather);
            this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", "å¥‡è¹Ÿç™¼ç”Ÿäº†ï¼ä½ ç²å¾—äº† <span class='rarity-legendary'>ä¸æ­»é³¥çš„ç¾½æ¯›</span>ï¼", "ğŸª¶");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }

        const roll = Math.random();
        let title = "ğŸ“¦ ç™¼ç¾å¯¶ç®±";
        let desc = "";
        let icon = "ğŸ“¦";

        let isThief = Player.class === 'thief';
        let safeRoll = isThief ? roll * 0.8 : roll; 

        if (safeRoll < 0.30) {
            const amount = Math.floor(Math.random() * 50) + 10 + (Player.depth * 2);
            Player.gold += amount;
            desc = `ç²å¾—äº† <span class='gold-text'>${amount} G</span>`;
	    this.showFloatingText(`+${amount} G`, "#ffd700", 'dmg-in');
        } else if (safeRoll < 0.60) {
            const item = this.generateSpecificItem(['consumable']);
            this.addItemToInventory(item);
            desc = `ç²å¾—äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`;
        } else if (safeRoll < 0.80) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addItemToInventory(item);
            desc = `ç²å¾—äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`;
        } else if (safeRoll < 0.90) {
            desc = "è£¡é¢ç©ºç©ºå¦‚ä¹Ÿ...";
        } else {
            const dmg = Math.floor(Player.maxHp * 0.15);
            Player.hp = Math.max(0, Player.hp - dmg);
            desc = `æ˜¯é™·é˜±ï¼å—åˆ°äº† <span class='damage-text'>${dmg}</span> é»å‚·å®³ã€‚`;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${dmg} HP`, "red");
            if(Player.hp === 0) { this.playerDie("æ­»æ–¼å¯¶ç®±é™·é˜±"); return; }
        }

        this.renderEvent(title, "ä½ æ‰“é–‹äº†å¯¶ç®±...", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    getWeightedMonster() {
        let activeMonsters = [];
        if (Player.depth < 50) {
            // å‰50å±¤åªå‡ºç¾è¼ƒå¼±çš„æ€ªç‰©
            let weakLimit = 4; 
            CONFIG.monsters.forEach((m, idx) => {
                if(idx < weakLimit) activeMonsters.push(m);
            });
        } else {
            activeMonsters = CONFIG.monsters;
        }

        let totalWeight = 0;
        for (let m of activeMonsters) totalWeight += m.weight;
        let randomVal = Math.random() * totalWeight;
        for (let m of activeMonsters) {
            if (randomVal < m.weight) return m;
            randomVal -= m.weight;
        }
        return activeMonsters[0];
    },

    triggerCombat(isForcedBoss, checkTrueForm) {
        GameState.phase = "combat";
        
        let baseMonster;
        let tier = "normal";
        let canFlee = true;

        if (isForcedBoss) {
            baseMonster = CONFIG.monsters[CONFIG.monsters.length - 1];
            tier = "boss";
            canFlee = false;
        } else {
            baseMonster = this.getWeightedMonster();
            let rand = Math.random();
            if (Player.depth > 300) {
                if (rand < 0.5) tier = "elite";
                else tier = "boss";
            } else if (Player.depth > 100) {
                if (rand < 0.1) tier = "boss";
                else if (rand < 0.6) tier = "elite"; else tier = "normal";
            } else {
                if (rand < 0.01) tier = "boss";
                else if (rand < 0.11) tier = "elite"; else tier = "normal";
            }
        }

        let hpMul = 1, atkMul = 1;
        let namePrefix = "";
        
        // 1. å…¨åŸŸæˆé•·ä¿‚æ•¸ï¼šæ¡ç”¨ä½åŸºç¤ï¼Œä¸”åŠ é€Ÿé»å»¶å¾Œ
        
        let growthRateHP = 0.007; // åŸºç¤æ¯å±¤ 0.7% (åŸ 1%)
        let growthRateATK = 0.005; // åŸºç¤æ¯å±¤ 0.5% (åŸ 0.8%)

        // æˆé•·åŠ é€Ÿé»å»¶å¾Œåˆ° 301 å±¤é–‹å§‹
        if (Player.depth > 300) {
            // å¾ 301 å±¤é–‹å§‹ï¼Œæ¯ 100 å±¤çš„æˆé•·å€ç‡æå‡ 1.5 å€
            let bonusRate = 1 + ((Player.depth - 300) / 100) * 0.5;
            growthRateHP *= bonusRate;
            growthRateATK *= bonusRate;
        }

        let globalHpScale = 1 + (Player.depth * growthRateHP);
        let globalAtkScale = 1 + (Player.depth * growthRateATK);
        
        // ç¢ºä¿è‡³å°‘æœ‰ 1 å€
        hpMul *= Math.max(1, globalHpScale);
        atkMul *= Math.max(1, globalAtkScale);


	// 2. æ·±æ·µæˆé•·ä¿‚æ•¸ï¼š500 å±¤å¾Œ (HP è®Šç¡¬ï¼ŒATK æˆé•·è¶¨ç·©)
        if (Player.depth > 500) {
            let abyssDepth = Player.depth - 500;
            
            // HP ç¶­æŒé«˜æˆé•· (1.5å€èµ·è·³)
            let finalHpScale = 1.5 + (Math.floor(abyssDepth / 50) * 0.1);

            // ATK æ”¹ç‚ºä½æˆé•· (1.1å€èµ·è·³)
            let finalAtkScale = 1.1 + (Math.floor(abyssDepth / 100) * 0.05);

            hpMul *= finalHpScale;
            atkMul *= finalAtkScale; // é€™æ¨£æ”»æ“ŠåŠ›å°±ä¸æœƒç›´æ¥ä¹˜ 1.5 äº†
            namePrefix += "æ·±æ·µ ";
        }

        // 3. éšç´šåŠ æˆ (å†æ¬¡é™ä½èè‹±æ€ªçš„å¨è„…æ€§ï¼Œè®“ä¸­æœŸæˆ°é¬¥æ›´å¯è¡Œ)
        if (tier === "elite") { 
            hpMul *= 1.4; // åŸ 1.8ï¼Œé™ç‚º 1.4 å€
            atkMul *= 1.2; // åŸ 1.3ï¼Œé™ç‚º 1.2 å€
            namePrefix += "èè‹± "; 
        } else if (tier === "boss") { 
            hpMul *= 2.0; // åŸ 2.5ï¼Œé™ç‚º 2.0 å€
            atkMul *= 1.5; // åŸ 1.8ï¼Œé™ç‚º 1.5 å€
            namePrefix += "é¦–é ˜ "; 
        }
        // --- [ä¿®æ”¹å¾Œçš„æ•¸å€¼è¨ˆç®—é‚è¼¯ çµæŸ] ---

        let enemy = {
            ...baseMonster,
            name: namePrefix + baseMonster.name,
            maxHp: Math.floor(baseMonster.hp * hpMul),
            hp: Math.floor(baseMonster.hp * hpMul),
            atk: Math.floor(baseMonster.atk * atkMul),
            tier: tier
        };
        // ... (å¾ŒçºŒä»£ç¢¼ä¸è®Š)
        if (checkTrueForm) {
            const hasSword = Player.equipment.weapon && Player.equipment.weapon.name === "å¦–åˆ€æ‘æ­£";
            const hasArmor = Player.equipment.armor && Player.equipment.armor.name === "å®ˆè¡›è€…é§ç”²";
            
            if (hasSword && hasArmor) {
                enemy.name = "é­”ç‹çœŸèº«";
                enemy.maxHp = 4000;
                enemy.hp = 4000;
                enemy.atk = 200;
                enemy.isTrueForm = true;
            }
        }

        GameState.currentEnemy = enemy;
        let iconClass = "monster-icon";
        if(tier === "elite") iconClass += " monster-elite glow-blue";
        if(tier === "boss") iconClass += " monster-boss glow-red";
        if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');
        
        // [æ–°å¢] åˆå§‹åŒ–æˆ°é¬¥å­ç‹€æ…‹ç‚º "main" (ä¸»é¸å–®)
        GameState.phase = "combat";

        this.renderEvent(`âš”ï¸ é­é‡ ${GameState.currentEnemy.name}`, 
            `HP: ${GameState.currentEnemy.hp} | æ”»æ“Š: ${GameState.currentEnemy.atk}`, 
            "æº–å‚™æˆ°é¬¥ï¼", GameState.currentEnemy.icon);
            
        // [æ–°å¢] æ”¹ç‚ºå‘¼å«æˆ°é¬¥é¸å–®æ¸²æŸ“å‡½å¼
        this.renderCombatMenu(); 
    },
    
// [ä¿®æ”¹] æ‰å¹³åŒ–æˆ°é¬¥é¸å–®ï¼šç›´æ¥é¡¯ç¤ºæŠ€èƒ½èˆ‡æ™®æ”»/é€ƒè·‘æŒ‰éˆ•
    renderCombatMenu() {
        if (GameState.phase !== 'combat') return;

        // 1. åˆ¤æ–·æ˜¯å¦ç‚º Boss (Boss ä¸èƒ½é€ƒè·‘)
        const isBoss = GameState.currentEnemy.tier === "boss";
        const canFlee = !isBoss; 

        // 2. è¨­å®šæŒ‰éˆ•ï¼šå·¦é‚Šæ™®æ”»ï¼Œå³é‚Šé€ƒè·‘
        // æ³¨æ„ï¼šæŠ€èƒ½æ˜¯é€éé»æ“Šæ–‡å­—å€å¡Šè§¸ç™¼ï¼Œä¸å ç”¨ä¸‹æ–¹æŒ‰éˆ•ç©ºé–“
        this.setButtons("âš”ï¸ æ™®é€šæ”»æ“Š", "combatRoundNormal", "é€ƒè·‘", "flee", !canFlee);

        // 3. ç›´æ¥æ¸²æŸ“æŠ€èƒ½åˆ—è¡¨åˆ°äº‹ä»¶æè¿°å€
        // å…ˆæª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æŠ€èƒ½åˆ—è¡¨äº†ï¼Œé¿å…é‡è¤‡æ¸²æŸ“
        if (!document.querySelector('.skill-list')) {
            this.renderSkillList();
        }
        
        // 4. ç§»é™¤èˆŠçš„æç¤ºæ–‡å­— (å¦‚æœé‚„æ®˜ç•™çš„è©±)
        const oldHint = document.querySelector('.combat-hint');
        if (oldHint) oldHint.remove();
    },

    // é€²å…¥è¡Œå‹•é¸å–® (æŒ‰ä¸‹ã€Œæˆ°é¬¥ã€å¾Œè§¸ç™¼)

    // åŸ·è¡Œæ™®é€šæ”»æ“Š (æŒ‰ä¸‹ã€Œæ™®é€šæ”»æ“Šã€å¾Œè§¸ç™¼)
    combatRoundNormal() {
        this.combatRound(null); // å‚³å…¥ null ä»£è¡¨æ™®é€šæ”»æ“Š
    },

    // åŸ·è¡ŒæŠ€èƒ½æ”»æ“Š (é»æ“Šå…·é«”æŠ€èƒ½å¾Œè§¸ç™¼)
    combatRoundSkill(skillId) {
        this.combatRound(skillId);
    },

// [ä¿®æ”¹] æ¸²æŸ“æŠ€èƒ½åˆ—è¡¨ (è¿½åŠ æ¨¡å¼)
    renderSkillList() {
        const container = document.getElementById('event-desc');
        
        // å»ºç«‹ä¸€å€‹åŒ…è£å®¹å™¨ï¼Œæ–¹ä¾¿ç®¡ç†æ¨£å¼
        const skillContainer = document.createElement('div');
        skillContainer.style.marginTop = "15px"; // èˆ‡ä¸Šæ–¹æ—¥èªŒæ‹‰é–‹ä¸€é»è·é›¢
        skillContainer.style.borderTop = "1px solid #444"; // åŠ ä¸€æ¢åˆ†éš”ç·šå¥½çœ‹ä¸€é»
        skillContainer.style.paddingTop = "10px";
        
        skillContainer.innerHTML = "<p style='margin-bottom:5px;'>è«‹é¸æ“‡è¦ä½¿ç”¨çš„æŠ€èƒ½ï¼š</p>";
        
        const list = document.createElement('div');
        list.className = 'skill-list';

        // éæ­·ç©å®¶æ“æœ‰çš„æŠ€èƒ½
        if (Player.skills && Player.skills.length > 0) {
            Player.skills.forEach(sid => {
                const skill = CONFIG.skills[sid];
                if (!skill) return;
                
                const cost = Number(skill.mpCost) || 0;
                const currentMp = Number(Player.mp) || 0;
                const canCast = currentMp >= cost;

                const rarityColor = CONFIG.rarityDisplay[skill.rarity] ? CONFIG.rarityDisplay[skill.rarity].color : "white";
                
                const item = document.createElement('div');
                item.className = `skill-item ${canCast ? '' : 'disabled'}`;
                item.innerHTML = `
                    <div style="width:100%">
                        <div style="display:flex; justify-content:space-between;">
                            <span class="${rarityColor}" style="font-weight:bold;">${skill.name}</span>
                            <span class="skill-cost">ğŸ’§ ${cost} MP</span>
                        </div>
                        <div class="skill-desc-box">${skill.desc}</div>
                    </div>
                `;
                
                if (canCast) {
                    item.onclick = () => {
                        // æ‰£é™¤é­”åŠ›ä¸¦åŸ·è¡ŒæŠ€èƒ½
                        Player.mp -= cost;
                        this.updateStatsUI();
                        this.combatRoundSkill(sid);
                    };
                }
                
                list.appendChild(item);
            });
        } else {
            skillContainer.innerHTML += "<p style='color:#888; font-size:0.8em;'>ä½ é‚„æ²’æœ‰å­¸æœƒä»»ä½•æŠ€èƒ½...</p>";
        }

        skillContainer.appendChild(list);
        container.appendChild(skillContainer); // [é—œéµ] é€™è£¡æ˜¯ç”¨ appendChild è¿½åŠ åˆ°æœ€å¾Œé¢
    },
// [æ–°å¢] åˆ·æ–°æŠ€èƒ½æŒ‰éˆ•çš„ç‹€æ…‹ (äº®èµ·/åç°)
    refreshSkillState() {
        // æ‰¾åˆ°æ‰€æœ‰æŠ€èƒ½æŒ‰éˆ•
        const items = document.querySelectorAll('.skill-item');
        // å–å¾—ç›®å‰çš„æŠ€èƒ½ ID åˆ—è¡¨
        const skillIds = Player.skills;

        items.forEach((item, index) => {
            const sid = skillIds[index];
            if (!sid) return;
            
            const skill = CONFIG.skills[sid];
            const cost = Number(skill.mpCost) || 0;
            const currentMp = Number(Player.mp) || 0;
            const canCast = currentMp >= cost;

            // æ›´æ–°æ¨£å¼
            if (canCast) {
                item.classList.remove('disabled');
                // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶ (ç¢ºä¿ç‹€æ…‹æ­£ç¢º)
                item.onclick = () => {
                    Player.mp -= cost;
                    this.updateStatsUI();
                    this.combatRoundSkill(sid);
                };
            } else {
                item.classList.add('disabled');
                item.onclick = null; // ç§»é™¤é»æ“Šäº‹ä»¶
            }
        });
    },
// [ä¿®æ”¹] å¿…é ˆæ¥æ”¶ skillId åƒæ•¸ï¼Œé è¨­ç‚º null (ä»£è¡¨æ™®æ”»)
    combatRound(skillId = null) {
        if (GameState.phase !== "combat") return;
        const enemy = GameState.currentEnemy;
        let logHtml = "";
        let pDmg = 0;       // ç©å®¶é€ æˆçš„å‚·å®³
        let isHeal = false; // æ˜¯å¦ç‚ºç´”æ²»ç™‚æŠ€èƒ½

        // [æ–°å¢] è‡ªç„¶å›é­” (æ¯å›åˆ +5)
        // ==========================================
        if (Player.mp < Player.maxMp) {
            let mpRegen = 5;
            // è¨­å®š 0.15 ç§’ (150ms) å»¶é²ï¼ŒéŒ¯é–‹ç²¾éˆå†ç”Ÿ(300ms)
            setTimeout(() => {
                // é˜²å‘†ï¼šå¦‚æœäººæ­»äº†å°±ä¸å›é­”
                if (Player.hp <= 0 || GameState.phase === 'dead') return;
                
                Player.mp = Math.min(Player.maxMp, Player.mp + mpRegen);
                
                // é¡¯ç¤ºè—è‰²æ–‡å­— (#2196f3)ï¼Œä½¿ç”¨ dmg-out (å·¦å´é£„å­—)
                this.showFloatingText(`+${mpRegen} MP`, "#2196f3", 'dmg-out');
                this.updateUI();
	// ğŸš¨ [æ–°å¢é€™è¡Œ] å›é­”å¾Œï¼Œç«‹åˆ»æª¢æŸ¥æŠ€èƒ½æŒ‰éˆ•æ˜¯å¦è©²äº®èµ·ä¾†ï¼
                this.refreshSkillState();
            }, 150);
            
            // å¯«å…¥æˆ°é¬¥æ—¥èªŒ
            logHtml += `<span style='color:#2196f3'>[è‡ªç„¶å›å¾©] æ¢å¾© ${mpRegen} MP</span><br>`;
        }
        // ==========================================

        // --- 1. å›åˆé–‹å§‹æ•ˆæœ ---
        
        // [éäºŒå…ƒæ€§åˆ¥] è¢«å‹•
        if (Player.gender === 'nonbinary') {
            let bonusG = Math.floor(Math.random() * 10) + 1;
            Player.gold += bonusG;
            logHtml += `<span style="color:#ff69b4">[éäºŒå…ƒå„ªå‹¢] ç²å¾— ${bonusG} G</span><br>`;
            setTimeout(() => { this.showFloatingText(`+${bonusG} G`, "#ff69b4", 'dmg-in'); }, 300);
        }

        // --- 2. ç©å®¶æ”»æ“Šè¨ˆç®— (å€åˆ†æŠ€èƒ½èˆ‡æ™®æ”») ---

        if (skillId) {
            // [æŠ€èƒ½å‚·å®³è¨ˆç®—]
            const skill = CONFIG.skills[skillId];
            const effect = skill.effect(Player, enemy);
            
            if (effect.flatDmg) pDmg += effect.flatDmg;
            if (effect.dmgMult) pDmg += Math.floor(this.getAtk() * effect.dmgMult);
            
            if (effect.healPct) {
                let heal = Math.floor(Player.maxHp * effect.healPct);
                Player.hp = Math.min(Player.maxHp, Player.hp + heal);
                this.showFloatingText(`+${heal} HP`, "#69f0ae", 'dmg-out');
                logHtml += `<span class='heal-text'>[æŠ€èƒ½] ${skill.name}: æ¢å¾© ${heal} HP</span><br>`;
                isHeal = true;
            }
            
            if (!isHeal) {
                // 1. å…ˆé¡¯ç¤ºæŠ€èƒ½åç¨±èˆ‡æè¿° (ç§»é™¤åŸæœ¬çµå°¾çš„ <br>)
                logHtml += `<span style="color:#4fc3f7">[æŠ€èƒ½] ${skill.name}: ${effect.text}</span>`;
                
                // 2. [æ–°å¢] å¦‚æœæœ‰é€ æˆå‚·å®³ï¼Œè£œä¸Šæ•¸å€¼é¡¯ç¤º
                if (pDmg > 0) {
                    logHtml += ` å° ${enemy.name} é€ æˆ <span class='damage-text'>${pDmg}</span> é»å‚·å®³ã€‚`;
                } else {
                    // å¦‚æœæ˜¯å–®ç´”åŠ  Buff æˆ–æ²’å‚·å®³çš„æŠ€èƒ½ (é ç•™)
                    logHtml += `ã€‚`; 
                }

                // 3. æœ€å¾Œæ‰æ›è¡Œ
                logHtml += `<br>`;

                // å¦‚æœæœ‰å‹•ç•«è¨­å®š (å¦‚ç«çƒè¡“)
                if (effect.anim) this.triggerAnim('event-icon', effect.anim); 
            }

        } else {
            // [æ™®é€šæ”»æ“Šè¨ˆç®—]
            pDmg = this.getAtk();
            let pCritRate = 0.05;

            if (Player.race === 'human') pCritRate += 0.25;
            if (Player.equipment.weapon && Player.equipment.weapon.name === "å¦–åˆ€æ‘æ­£") pCritRate += 0.20;

            if (Player.buff) {
                if (Player.buff.id === 'angel_courage') pCritRate = 0.2;
                if (Player.buff.id === 'demon_enhance') pCritRate = 0.5;
                
                if (Player.buff.id === 'demon_wealth') {
                    Player.gold += 5;
                    setTimeout(() => { this.showFloatingText("+5 G", "gold", 'dmg-in'); }, 150);
                    logHtml += `<span class='demon-text'>[æƒ¡é­”è²¡å¯Œ]</span> ç²å¾— 5 G<br>`;
                }
                
                if (Player.buff.id === 'demon_destruction') {
                    if (Math.random() < 0.1) {
                        enemy.hp = 0;
                        let pain = Math.floor(Player.hp * 0.9);
                        Player.hp -= pain;
                        this.showFloatingText(`-${pain} HP`, "darkred");
                        logHtml += `<span class='demon-text'>[æƒ¡é­”ç ´å£]</span> è§¸ç™¼ç§’æ®ºï¼è‡ªèº«æ‰£é™¤ ${pain} HPã€‚<br>`;
                        this.combatWin();
                        this.updateUI();
                        return;
                    }
                }
            }

            let pCrit = Math.random() < pCritRate;
            if (pCrit) {
                pDmg *= 2;
                if (Player.orientation === 'hetero') {
                    pDmg = Math.floor(pDmg * 1.2);
                    logHtml += `<span style="color:#e91e63">[ç•°æ€§æˆ€ä¹‹åŠ›] æš´æ“Šå‚·å®³å¤§å¹…æå‡!</span><br>`;
                }
            }
            
            logHtml += `ä½ å° ${enemy.name} é€ æˆ ${pCrit ? "<span class='crit-text'>çˆ†æ“Š " : ""}${pDmg}${pCrit ? "</span>" : ""} é»å‚·å®³ã€‚<br>`;
        }

        // --- çµç®—å‚·å®³èˆ‡å¸è¡€ ---
        if (pDmg > 0) {
            enemy.hp -= pDmg;
            this.triggerAnim('event-icon', 'anim-damage');
            this.showFloatingText(pDmg, "white", 'dmg-out');
            
            if (Player.race === 'demon') {
                let steal = Math.floor(pDmg * 0.15);
                if (steal > 0) {
                    Player.hp = Math.min(Player.maxHp, Player.hp + steal);
                    this.showFloatingText(`+${steal} HP`, "#ef5350", 'dmg-out');
                    logHtml += `<span class='demon-text'>[ç”Ÿå‘½å·å–] å¸å– ${steal} HP</span><br>`;
                }
            }
        }

        // åˆ¤å®šæ•µäººæ­»äº¡
        if (enemy.hp <= 0) {
            this.combatWin();
            return;
        }

        // --- 3. æ€ªç‰©æ”»æ“Š (Enemy Attack) ---
        let mDmg = enemy.atk;
        let mCritRate = 0.1;
        
        if (Player.buff && Player.buff.id === 'demon_enhance') mCritRate = 0.5;
        if (Player.buff && Player.buff.id === 'angel_protection') mDmg = Math.floor(mDmg * 0.7);
        if (Player.gender === 'none') mDmg = Math.floor(mDmg * 0.90);

        let mCrit = Math.random() < mCritRate;
        if (mCrit) mDmg *= 2;

        let applyDamage = true;
        let s = Player.equipment.shield;
        this.triggerAnim('event-icon', 'anim-lunge');

        if (s && s.val > 0) {
             s.val--;
             let isPierced = (mCrit && s.name !== "åŸƒç™¸æ–¯ä¹‹ç›¾" && s.name !== "å†¥ç‹ä¹‹ç›¾");
             if (isPierced) {
                 logHtml += `<span class='pierce-text'>âš¡ è‡´å‘½ä¸€æ“Šè²«ç©¿äº†ç›¾ç‰Œï¼</span><br>`;
             } else {
                 applyDamage = false;
                 this.showFloatingText("æ ¼æ“‹!", "#2196f3", 'dmg-in');
                 logHtml += `<span class='block-text'>ğŸ›¡ï¸ ç›¾ç‰ŒæŠµæ“‹äº†æ”»æ“Šï¼</span> (å‰©é¤˜è€ä¹…: ${s.val})<br>`;
             }

             if (s.val <= 0) {
                 logHtml += `<span class='damage-text'>ğŸ’” ä½ çš„ ${s.name} ç¢è£‚äº†ï¼</span><br>`;
                 Player.equipment.shield = null;
                 this.recalcStats(); 
             }
        }

        if (applyDamage) {
            if (Player.race === 'orc') {
                let reduced = Math.floor(mDmg * 0.20);
                mDmg -= reduced;
            }

            Player.hp -= mDmg;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${mDmg}`, "red", 'dmg-in');
            
            logHtml += `${enemy.name} æ”»æ“Šï¼é€ æˆ ${mCrit ? "<span class='crit-text'>è‡´å‘½ " : ""}${mDmg}${mCrit ? "</span>" : ""} é»å‚·å®³ã€‚`;
            if (Player.race === 'orc') logHtml += ` (ç¸äººç¡¬çš®)`;
            if (Player.gender === 'none') logHtml += ` (å¿ƒå¦‚æ­¢æ°´)`;
        }

        // --- [ç²¾éˆå†ç”Ÿ] ---
        if (Player.race === 'elf') {
            let regen = Math.floor(Player.maxHp * 0.05);
            if(Player.hp < Player.maxHp) {
                setTimeout(() => {
                    if (Player.hp <= 0 || GameState.phase === 'dead') return;
                    Player.hp = Math.min(Player.maxHp, Player.hp + regen);
                    this.showFloatingText(`+${regen} HP (å†ç”Ÿ)`, "#69f0ae", 'dmg-out');
                    this.updateUI();
                }, 300);
                logHtml += `<br><span class='heal-text'>[ç²¾éˆå†ç”Ÿ] æ¢å¾© ${regen} HP</span>`;
            }
        }


        this.renderEvent(`âš”ï¸ æˆ°é¬¥ä¸­ - ${enemy.name}`, 
            `HP: ${Math.max(0, enemy.hp)} | <span style="color:#ff5252">æ”»æ“Š: ${enemy.atk}</span>`, 
            logHtml, enemy.icon);
            
        if (Player.hp <= 0) {
            this.playerDie(`è¢« ${enemy.name} æ®ºæ­»`);
        } else {
            this.updateUI();
            this.renderCombatMenu();
        }
    },

    combatWin() {
        const enemy = GameState.currentEnemy; // åŸæœ¬çš„ç¬¬ 1197 è¡Œ
        
        // --- [æ–°å¢] æˆ°é¬¥å‹åˆ©ç«‹å³è§¸ç™¼å†ç”Ÿ (å¸¶å»¶é²)ï¼Œä¸¦æ¨™è¨˜è·³éä¸‹ä¸€æ¬¡ ---
        if (Player.race === 'elf' || (Player.buff && Player.buff.id === 'angel_song')) {
            let healAmount = 0;
            if (Player.race === 'elf') healAmount += Math.floor(Player.maxHp * 0.05);
            if (Player.buff && Player.buff.id === 'angel_song') healAmount += 10;

            if (Player.hp < Player.maxHp) {
                // è¨­å®šæ——æ¨™ï¼šå‘Šè¨´ nextEvent é€™æ¬¡ä¸ç”¨å†è£œäº†ï¼Œå› ç‚ºé€™è£¡è£œéäº†
                GameState.skipNextRegen = true;

                // 0.3ç§’å»¶é²é¡¯ç¤ºç‰¹æ•ˆèˆ‡æ•¸å€¼æ›´æ–°
                setTimeout(() => {
                    // å†æ¬¡é˜²å‘†ï¼Œé¿å…æ¥µç«¯ç‹€æ³ä¸‹å ±éŒ¯
                    if (Player.hp <= 0 || GameState.phase === 'dead') return;

                    Player.hp = Math.min(Player.maxHp, Player.hp + healAmount);
                    this.showFloatingText(`+${healAmount} HP (å‹åˆ©)`, "#69f0ae", 'dmg-out');
                    this.updateUI(); // ç¢ºä¿è¡€æ¢æ›´æ–°
                }, 300);
            }
        }
        
        GameState.phase = "event_end";
        
        if(Player.depth === 1000 && enemy.tier === 'boss') {
            Player.kill1000Boss = true;
        }

        let drops = [];
        let dropText = "";

        let gold = enemy.baseGold;
        if (enemy.tier === "elite") gold *= 2;
        if (enemy.tier === "boss") gold *= 5;
        
        Player.gold += gold;
	this.showFloatingText(`+${gold} G`, "#ffd700", 'dmg-in');
        dropText += `é‡‘å¹£ +${gold} <br>`;

        if (enemy.isTrueForm) {
            if (CONFIG.lootData["çœŸå¯¦ä¹‹å¿ƒ"]) {
                let loot = { ...CONFIG.lootData["çœŸå¯¦ä¹‹å¿ƒ"], name: "çœŸå¯¦ä¹‹å¿ƒ", type: "loot" };
                drops.push(loot);
            }
        } else {
            if (Math.random() < 0.7) {
                if (CONFIG.lootData[enemy.drop]) {
                    let loot = { ...CONFIG.lootData[enemy.drop], name: enemy.drop, type: "loot" };
                    drops.push(loot);
                }
            }
            if (enemy.tier === "elite" || enemy.tier === "boss") {
                if (Math.random() < 0.3 && CONFIG.lootData[enemy.eliteDrop]) {
                    let loot = { ...CONFIG.lootData[enemy.eliteDrop], name: enemy.eliteDrop, type: "loot" };
                    drops.push(loot);
                }
            }
            if (enemy.tier === "boss") {
                if (Math.random() < 0.1 && CONFIG.lootData[enemy.bossDrop]) {
                    let loot = { ...CONFIG.lootData[enemy.bossDrop], name: enemy.bossDrop, type: "loot" };
                    drops.push(loot);
                }
            }
        }

        if (Math.random() < 0.1) {
            drops.push(this.generateRandomItem(enemy.tier));
        }

        drops.forEach(item => {
            this.addItemToInventory(item);
            let colorClass = item.rarity ? CONFIG.rarityDisplay[item.rarity].color : "";
            if(item.rarity === 'mythic') colorClass = 'rarity-mythic';
            dropText += `ç²å¾— <span class='${colorClass}'>${item.name}</span><br>`;
        });
        let winTitle = enemy.isTrueForm ? "ğŸ‘‘ å¼’ç¥è€…" : "ğŸ† æˆ°é¬¥å‹åˆ©";
        let winMsg = enemy.isTrueForm ? "ä½ æ“Šæ•—äº†é­”ç‹çœŸèº«ï¼Œå‚³èªªå°‡æ°¸é æµå‚³ï¼" : "ä½ æ“Šæ•—äº†æ•µäººï¼";
        this.renderEvent(winTitle, winMsg, dropText || "æ²’æœ‰æ‰è½ä»»ä½•ç‰©å“ã€‚", "ğŸ‰");
        document.getElementById('event-icon').className = "monster-icon"; 
        
        this.checkAchievements();
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

    flee() {
        let fleeRate = 0.5;
        if (Player.buff) {
            if (Player.buff.id === 'angel_wings') fleeRate = 0.7;
            if (Player.buff.id === 'demon_wager') {
                fleeRate = 0.85;
                if (Math.random() < 0.015) {
                    Player.hp = 0;
                    this.playerDie("æ­»æ–¼æƒ¡é­”è³­ç´„");
                    return;
                }
            }
        }

        if (Math.random() < fleeRate) {
            GameState.phase = "event_end";
            this.renderEvent("ğŸ’¨ é€ƒè·‘æˆåŠŸ", "ä½ æˆåŠŸç”©æ‰äº†æ€ªç‰©ã€‚", "", "ğŸƒ");
            document.getElementById('event-icon').className = "monster-icon";
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        } else {
            const enemy = GameState.currentEnemy;
            let mDmg = enemy.atk;
            let msg = "";
            let s = Player.equipment.shield;
            
            this.triggerAnim('event-icon', 'anim-lunge');
            if (s && s.val > 0) {
                s.val--;
		this.showFloatingText("æ ¼æ“‹!", "#2196f3", 'dmg-in');
                msg = `é€ƒè·‘å¤±æ•—ï¼ä½†<span class='block-text'>ç›¾ç‰ŒæŠµæ“‹äº†è¿½æ“Š</span>ï¼`;
                if (s.val <= 0) {
                    msg += `<br><span class='damage-text'>ğŸ’” ä½ çš„ ${s.name} ç¢è£‚äº†ï¼</span>`;
                    Player.equipment.shield = null;
                    this.recalcStats();
                }
            } else {
    // Player.hp -= mDmg; // åŸæœ¬çš„ç›´æ¥æ‰£è¡€

    // [æ–°å¢] é€ƒè·‘å¤±æ•—æ™‚çš„æ¸›å‚·é‚è¼¯
    if (Player.race === 'orc') {
        mDmg = Math.floor(mDmg * 0.80); // 
    }

    Player.hp -= mDmg;
    this.triggerAnim('game-container', 'anim-screen-shake');
		this.showFloatingText(`-${mDmg}`, "red", 'dmg-in');
                msg = `é€ƒè·‘å¤±æ•—ï¼è¢« ${enemy.name} æ”»æ“Šé€ æˆ ${mDmg} å‚·å®³ã€‚`;
                if (Player.buff && Player.buff.id === 'demon_wealth') {
                    if (Player.gold >= 5) {
                        Player.gold -= 5;
                        this.showFloatingText("-5 G", "red");
                        msg += `<br><span class='demon-text'>[æƒ¡é­”è²¡å¯Œ]</span> æå¤± 5 G`;
                    }
                }
            }
            
            if (Player.hp <= 0) {
                this.playerDie(`åœ¨é€ƒè·‘æ™‚è¢« ${enemy.name} æ®ºæ­»`);
            } else {
                this.renderEvent(`âš”ï¸ ${enemy.name}`, `æ•µæ–¹ HP: ${enemy.hp}`, msg, enemy.icon);
                this.updateUI();
                
                // ğŸš¨ğŸš¨ğŸš¨ [æ–°å¢é€™è¡Œ] é‡æ–°æ¸²æŸ“æˆ°é¬¥é¸å–® (åŒ…å«æŠ€èƒ½åˆ—è¡¨) ğŸš¨ğŸš¨ğŸš¨
                this.renderCombatMenu(); 
            }
        }
    },

    playerDie(reason) {
        const featherIdx = Player.inventory.material.findIndex(i => i.id === 'phoenix_feather');
        if (featherIdx !== -1) {
            Player.inventory.material.splice(featherIdx, 1);
            Player.hp = Math.floor(Player.maxHp * 0.5);
            
            if (GameState.phase === 'combat' && GameState.currentEnemy) {
                this.renderEvent(`âš”ï¸ æµ´ç«é‡ç”Ÿ`, `æ•µæ–¹ HP: ${GameState.currentEnemy.hp}`, "ä¸æ­»é³¥çš„ç¾½æ¯›è®“ä½ å¾©æ´»äº†ï¼æˆ°é¬¥ç¹¼çºŒï¼", GameState.currentEnemy.icon);
                this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", false);
            } else {
                this.renderEvent("ğŸ”¥ æµ´ç«é‡ç”Ÿ", "ä¸æ­»é³¥çš„ç¾½æ¯›ç™¼å‡ºè€€çœ¼å…‰èŠ’...", "ä½ å¾©æ´»äº†ï¼æ¢å¾© 50% ç”Ÿå‘½å€¼ã€‚", "ğŸ¦…");
                GameState.phase = "event_end";
                this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            }
            
            this.updateUI();
            return;
        }

        GameState.phase = "dead";
        Player.hp = 0;
        this.updateUI();
        // æ­»äº¡æ™‚æ¸…é™¤å­˜æª”
        localStorage.removeItem('fantasy_adventure_save');
        let cause = reason ? reason : "æœªçŸ¥åŸå› ";
        this.renderEvent("â˜ ï¸ ä½ æ­»äº†", `æ­»å› ï¼š${cause}<br>å†’éšªçµæŸã€‚æœ€çµ‚æ·±åº¦: ${Player.depth}`, "é‡æ–°æ•´ç†ç¶²é ä»¥é‡æ–°é–‹å§‹", "ğŸª¦");
        this.setButtons("é‡æ–°å†’éšª", "restart", "ç„¡", null, true);
    },

    restart() {
        location.reload();
    },

    generateRandomItem(tierModifier = "normal") {
        const r = Math.random();
        let rarityKey = "common";
        
        // 1. è¤‡è£½åŸºç¤æ©Ÿç‡è¡¨
        let dynamicTable = { ...CONFIG.rarityProb };
        
        // 2. æ‡‰ç”¨æ·±åº¦æˆé•·é‚è¼¯ (Dynamic Scaling)
        let reductionFactor = 0;
        
        if (Player.depth > 100) {
            // å¾ 101 å±¤é–‹å§‹è¨ˆç®—é™ä½çš„æ¯”ä¾‹
            // åœ¨ 300 å±¤ (200 / 200) é”åˆ° 100% å‰Šæ¸›
            reductionFactor = Math.min(1, (Player.depth - 100) / 200); 
        }
        
        // å‰Šæ¸› low/uncommon æ©Ÿç‡ï¼Œä¸¦å°‡æ©Ÿç‡åˆ†é…çµ¦ high-tier
        let boostFromLow = 0;
        
        if (reductionFactor > 0) {
            // å‰Šæ¸› low-tier æ©Ÿç‡
            boostFromLow += dynamicTable.common * reductionFactor;
            dynamicTable.common *= (1 - reductionFactor);
            
            boostFromLow += dynamicTable.uncommon * reductionFactor;
            dynamicTable.uncommon *= (1 - reductionFactor);
            
            // ç¢ºä¿ 300 å±¤å¾Œä¸å†å‡ºç¾ common/uncommon
            if (Player.depth >= 300) {
                dynamicTable.common = 0;
                dynamicTable.uncommon = 0;
            }

            // å°‡é‡‹æ”¾å‡ºçš„æ©Ÿç‡ boostFromLow æŒ‰æ¯”ä¾‹åˆ†é…çµ¦é«˜ç¨€æœ‰åº¦
            let highTiers = ['rare', 'epic', 'legendary', 'mythic', 'ultra'];
            let totalHighProb = highTiers.reduce((sum, key) => sum + dynamicTable[key], 0);

            if (totalHighProb > 0) {
                 // æŒ‰ç¾æœ‰æ©Ÿç‡æ¯”ä¾‹ï¼Œåˆ†é… boostFromLow æ©Ÿç‡
                 let boostRatio = 1 + (boostFromLow / totalHighProb);
                 
                 dynamicTable.rare *= boostRatio;
                 dynamicTable.epic *= boostRatio;
                 dynamicTable.legendary *= boostRatio;
                 dynamicTable.mythic *= boostRatio;
                 dynamicTable.ultra *= boostRatio;
            }
        }
        
        // 3. é‡æ–°è¨ˆç®—ç´¯è¨ˆæ©Ÿç‡é€²è¡ŒæŠ½ç (Accrued Probability Check)
        let acc = 0;
        // æ’åºç¢ºä¿å¾é«˜ç¨€æœ‰åº¦é–‹å§‹æª¢æŸ¥ (æ›´å®‰å…¨)
        let keys = Object.keys(dynamicTable).sort((a, b) => CONFIG.rarityDisplay[b].val - CONFIG.rarityDisplay[a].val);

        for (let key of keys) {
            acc += dynamicTable[key];
            if (r <= acc) { rarityKey = key; break; }
        }

        if (tierModifier === "boss" && (rarityKey === "common" || rarityKey === "uncommon")) rarityKey = "rare";
        
        const pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey);
        // æœ€çµ‚é˜²å‘†ï¼šå¦‚æœæŠ½åˆ°ç¨€æœ‰åº¦ä½†æ± å­æ˜¯ç©ºçš„ï¼Œå˜—è©¦é‡æ–°æŠ½å–
        if (pool.length === 0) return this.generateRandomItem("normal");

        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },

    generateSpecificItem(allowedTypes) {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        let pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey && allowedTypes.includes(i.type));
        if (pool.length === 0) pool = CONFIG.itemPool.filter(i => allowedTypes.includes(i.type));
        const template = pool[Math.floor(Math.random() * pool.length)];
        // ç¢ºä¿è¿”å›ä¸€å€‹å…¨æ–°çš„ã€éå¼•ç”¨çš„ç‰©ä»¶ã€‚
        return Object.assign({}, template);
    },

	// [ä¿®æ”¹] ç‰©å“å †ç–Šé‚è¼¯
    addItemToInventory(item, render = true) {
        Player.history.items.add(item.name);
        
        let targetList;
        if (['weapon', 'armor', 'shield'].includes(item.type)) {
            targetList = Player.inventory.equipment;
        } else if (item.type === 'consumable') {
            targetList = Player.inventory.consumable;
        } else {
            targetList = Player.inventory.material;
        }

        // 1. å°‹æ‰¾æ˜¯å¦å·²æœ‰ç›¸åŒçš„ç‰©å“
        // åˆ¤æ–·æ¨™æº–ï¼šåç¨±ã€ç¨€æœ‰åº¦ã€æ•¸å€¼(val)éƒ½å¿…é ˆç›¸åŒ
        // é€™å°±å®Œç¾è§£æ±ºäº†ç›¾ç‰Œå•é¡Œï¼š(3/3)çš„ç›¾ç‰Œæœƒç–Šä¸€èµ·ï¼Œ(2/3)çš„ç›¾ç‰Œå› ç‚º val ä¸åŒï¼Œæœƒå¦é–‹ä¸€æ ¼
        const existingItem = targetList.find(i => 
            i.name === item.name && 
            i.rarity === item.rarity && 
            i.val === item.val
        );

        if (existingItem) {
            // 2. å¦‚æœæœ‰ï¼Œæ•¸é‡ +1
            existingItem.count = (existingItem.count || 1) + 1;
        } else {
            // 3. å¦‚æœæ²’æœ‰ï¼Œåˆå§‹åŒ–æ•¸é‡ç‚º 1 ä¸¦åŠ å…¥åˆ—è¡¨
            item.count = 1;
            targetList.push(item);
        }

        if (render) this.updateUI();
    },

    handleItemClick(index, category) {
        // [ä¿®æ­£] æ­»äº¡ç‹€æ…‹ç¦æ­¢æ“ä½œèƒŒåŒ…ï¼Œé˜²æ­¢æ­»å¾Œå–æ°´å¾©æ´»
        if (Player.hp <= 0 || GameState.phase === 'dead') return;
        if (GameState.phase === "merchant") {
            this.sellItem(index, category);
            return;
        }
        const item = Player.inventory[category][index];
        if (['weapon', 'armor', 'shield'].includes(item.type)) {
            if(confirm(`è¦è£å‚™ ${item.name} (${this.getItemDesc(item)}) å—ï¼Ÿ`)) this.equip(index, category);
        } else if (item.type === 'consumable') {
            if(confirm(`è¦ä½¿ç”¨ ${item.name} (${item.desc}) å—ï¼Ÿ`)) this.useItem(index, category);
        } else {
             alert(`${item.name}: ${item.desc || "ç´ æ/æˆ°åˆ©å“"}`);
        }
    },

	// [ä¿®æ”¹] è£å‚™ç‰©å“ (æ”¯æ´å †ç–Šæ‹†åˆ†)
    equip(index, category) {
        const stackItem = Player.inventory[category][index];
        if (!stackItem) return;
        
        const type = stackItem.type;
        if (!['weapon', 'armor', 'shield'].includes(type)) return;

        // 1. å…ˆæŠŠèº«ä¸ŠåŸæœ¬çš„è£å‚™è„«ä¸‹ä¾† (æ”¾å›èƒŒåŒ…ï¼Œæœƒè‡ªå‹•å †ç–Š)
        if (Player.equipment[type]) {
            this.addItemToInventory(Player.equipment[type], false);
        }

        // 2. æº–å‚™è¦è£å‚™çš„ç‰©å“ (è¤‡è£½ä¸€ä»½ï¼Œæ•¸é‡è¨­ç‚º 1)
        const itemToEquip = { ...stackItem };
        itemToEquip.count = 1;
        Player.equipment[type] = itemToEquip;

        // 3. è™•ç†èƒŒåŒ…è£¡çš„å †ç–Š
        if (stackItem.count > 1) {
            stackItem.count--; // æ•¸é‡å¤§æ–¼ 1ï¼Œæ‰£é™¤ä¸€å€‹
        } else {
            Player.inventory[category].splice(index, 1); // å‰©æœ€å¾Œä¸€å€‹ï¼Œç›´æ¥ç§»é™¤
        }
        
        this.recalcStats();
        this.updateUI();    
        this.log(`è£å‚™äº† ${itemToEquip.name}`);
    },
    unequip(type) {
        if (!Player.equipment[type]) return;
        const item = Player.equipment[type];
        
        this.addItemToInventory(item, false); 
        Player.equipment[type] = null;
        
        // Recalculate Stats (handles MaxHP/HP ratio)
        this.recalcStats();
        this.updateUI();
        this.log(`å¸ä¸‹äº† ${type === 'weapon' ? 'æ­¦å™¨' : type === 'armor' ? 'é˜²å…·' : 'ç›¾ç‰Œ'}`);
    },

	// [ä¿®æ”¹] ä½¿ç”¨æ¶ˆè€—å“ (æ”¯æ´å †ç–Šæ‰£é™¤)
    useItem(index, category) {
        const item = Player.inventory[category][index];
        
        if (item.name.includes("è—¥æ°´") || item.name.includes("è—¥åŠ‘")) {
            // è£œè¡€é‚è¼¯
            let heal = item.val;
            // å¦‚æœæ˜¯å…¨èƒ½è—¥æ°´æˆ–ç‰¹æ®Šè—¥æ°´ï¼Œå¯èƒ½æœƒæœ‰ä¸åŒé‚è¼¯ï¼Œé€™è£¡æ²¿ç”¨ä½ çš„åŸºç¤å›è¡€
            Player.hp = Math.min(Player.maxHp, Player.hp + heal);
            
            // [é‡é»] æ‰£é™¤æ•¸é‡é‚è¼¯
            if (item.count > 1) {
                item.count--;
            } else {
                Player.inventory[category].splice(index, 1);
            }

            this.showFloatingText(`+${heal} HP`, "#69f0ae");
            this.updateUI();
        }
    },

    log(msg) { console.log(msg); },

    renderGMStatus(status) {
        const header = document.getElementById('event-title');
        if (header) {
            header.innerHTML = header.innerText + ` <span style="font-size:0.5em; color:#ff0055;">[${status}]</span>`;
        }
    },
    renderEvent(title, subtitle, content, icon) {
        document.getElementById('event-title').innerText = title;
        document.getElementById('event-desc').innerHTML = `<p>${subtitle}</p><p>${content}</p>`;
        if(icon) document.getElementById('event-icon').innerText = icon;
        if(GameState.phase !== 'merchant') document.getElementById('merchant-area').classList.add('hidden');
    },

    setButtons(mainText, mainAction, subText, subAction, disableSub) {
        const b1 = document.getElementById('btn-main');
        const b2 = document.getElementById('btn-sub');
        b1.innerText = mainText;
        b1.onclick = () => Game[mainAction]();
        b2.innerText = subText;
        if (subAction) b2.onclick = () => Game[subAction]();
        b2.disabled = disableSub;
    },

    updateUI() {
        this.updateStatsUI();

        const w = Player.equipment.weapon;
        const a = Player.equipment.armor;
        const s = Player.equipment.shield;
        
        const wEl = document.getElementById('slot-weapon');
        wEl.innerHTML = w ? `<span class="${CONFIG.rarityDisplay[w.rarity].color}">${w.icon} ${w.name} (+${w.val})</span>` : "ç„¡æ­¦å™¨";
        wEl.className = `equip-slot ${w ? CONFIG.rarityDisplay[w.rarity].color : ''}`;

        const aEl = document.getElementById('slot-armor');
        aEl.innerHTML = a ? `<span class="${CONFIG.rarityDisplay[a.rarity].color}">${a.icon} ${a.name} (+${a.val})</span>` : "ç„¡é˜²å…·";
        aEl.className = `equip-slot ${a ? CONFIG.rarityDisplay[a.rarity].color : ''}`;

        const sEl = document.getElementById('slot-shield');
        sEl.innerHTML = s ? `<span class="${CONFIG.rarityDisplay[s.rarity].color}">${s.icon} ${s.name} (${s.val})</span>` : "ç„¡ç›¾ç‰Œ";
        sEl.className = `equip-slot ${s ? CONFIG.rarityDisplay[s.rarity].color : ''}`;

        this.renderInvList('inv-equip', Player.inventory.equipment, 'equipment');
        this.renderInvList('inv-consum', Player.inventory.consumable, 'consumable');
        this.renderInvList('inv-mat', Player.inventory.material, 'material');
        // è‡ªå‹•å­˜æª”è§¸ç™¼é»ï¼šåªè¦ UI æ›´æ–°ä¸”éè®€å–ä¸­ä¸”æ´»è‘—ï¼Œå°±è‡ªå‹•å­˜æª”
        if (!GameState.isLoading && Player.hp > 0 && Player.class && Player.race) {
            this.saveGame();
        }
    },

	updateStatsUI() {
        document.getElementById('hp-val').innerText = Player.hp;
        document.getElementById('max-hp-val').innerText = Player.maxHp;
        
        // [æ–°å¢] è£œä¸Šé€™å…©è¡Œä¾†æ›´æ–°ä»‹é¢ä¸Šçš„é­”åŠ›æ•¸å€¼
        document.getElementById('mp-val').innerText = Player.mp;
        document.getElementById('max-mp-val').innerText = Player.maxMp;

        document.getElementById('atk-val').innerText = this.getAtk();
        document.getElementById('gold-val').innerText = Player.gold;
        document.getElementById('depth-val').innerText = Player.depth;
        
        const buffEl = document.getElementById('buff-display');
        if (Player.buff) {
            const style = Player.buff.type === 'angel' ? 'angel-text' : 'demon-text';
            buffEl.innerHTML = `ç‹€æ…‹: <span class="${style}">${Player.buff.name}</span> <span style="font-size:0.8em; cursor:pointer;">(é»æ“ŠæŸ¥çœ‹)</span>`;
            buffEl.onclick = () => alert(`${Player.buff.name}\n\n${Player.buff.desc}`);
        } else {
            buffEl.innerHTML = `ç‹€æ…‹: ç„¡`;
            buffEl.onclick = null;
        }
    },

	// [ä¿®æ”¹] æ¸²æŸ“èƒŒåŒ…åˆ—è¡¨ (é¡¯ç¤ºæ•¸é‡èˆ‡ç›¾ç‰Œè€ä¹…)
    renderInvList(id, items, category) {
        const list = document.getElementById(id);
        list.innerHTML = "";
        
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `item ${CONFIG.rarityDisplay[item.rarity].color}`;
            
            // ç‰¹æ®Šé‚Šæ¡†æ•ˆæœ
            if (item.rarity === 'epic') div.classList.add('rare-epic');
            if (item.rarity === 'legendary') div.classList.add('rare-legendary');
            if (item.rarity === 'mythic') div.classList.add('rarity-mythic');
            
            // æº–å‚™é¡¯ç¤ºæ–‡å­—
            let displayText = `${item.icon || 'ğŸ“¦'} ${item.name}`;
            
            // å¦‚æœæ˜¯ç›¾ç‰Œï¼Œé¡¯ç¤ºå‰©é¤˜æ ¼æ“‹æ¬¡æ•¸
            if (item.type === 'shield') {
                displayText += ` <span style="font-size:0.8em; color:#aaa;">(å‰©é¤˜:${item.val})</span>`;
            } 
            // è£å‚™é¡¯ç¤ºæ•¸å€¼ (+æ”»/+é˜²)
            else if (['weapon', 'armor'].includes(item.type)) {
                displayText += ` <span style="font-size:0.8em; color:#aaa;">(+${item.val})</span>`;
            }

            // [é‡é»] å¦‚æœæ•¸é‡å¤§æ–¼ 1ï¼Œé¡¯ç¤ºå †ç–Šæ•¸é‡
            if (item.count > 1) {
                displayText += ` <span style="font-weight:bold; color:white;">x${item.count}</span>`;
            }

            div.innerHTML = displayText;
            div.onclick = () => this.handleItemClick(idx, category);
            list.appendChild(div);
        });
    }
};

// -------------------------------------------------------

const GM = {
    isEnabled: false,
    // 1. è¨­å®š GM å·¥å…·æ˜¯å¦å•Ÿç”¨ (é è¨­é—œé–‰)
    isEnabled: false, 

    /**
     * é–‹å•Ÿæˆ–é—œé–‰ GM æ¨¡å¼ã€‚
     * @param {boolean} enable - true ç‚ºé–‹å•Ÿï¼Œfalse ç‚ºé—œé–‰ã€‚
     */
    toggle(enable) {
        this.isEnabled = enable;
        const status = enable ? "å·²å•Ÿç”¨" : "å·²åœç”¨";
        console.warn(`GM TOOL: åµæ¸¬æ¨¡å¼ ${status}.`);
        if (!enable) {
            // é—œé–‰æ™‚æ¸…ç©ºæš«å­˜æ•¸æ“š
            localStorage.removeItem('gm_enabled');
        } else {
            // é–‹å•Ÿæ™‚æ¨™è¨˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¼‰å…¥æ™‚æé†’
            localStorage.setItem('gm_enabled', 'true');
        }
        Game.renderGMStatus(status);
    },

    /**
     * å‚³é€ç©å®¶åˆ°æŒ‡å®šæ·±åº¦ï¼Œä¸¦åˆ·æ–°å•†åº—/æˆ°é¬¥é‚è¼¯ã€‚
     * @param {number} depth - ç›®æ¨™å±¤æ•¸
     */
    teleport(depth) {
        if (!this.isEnabled) return console.error("GM TOOL: è«‹å…ˆä½¿ç”¨ GM.toggle(true) å•Ÿç”¨å·¥å…·ã€‚");
        if (depth < 0) depth = 0;
        
        Player.depth = depth;
        Player.dailyRefreshCount = 0; // é‡ç½®å•†åº—åˆ·æ–°æ¬¡æ•¸
        Game.updateUI();
        Game.log(`[GM] å‚³é€è‡³ç¬¬ ${depth} å±¤ã€‚`);
        Game.renderEvent("ğŸ”§ GM å‚³é€", `å·²å°‡æ·±åº¦è¨­å®šç‚º ${depth} å±¤ã€‚`, "è«‹é»æ“Šã€Œç¹¼çºŒã€é€²å…¥ä¸‹ä¸€äº‹ä»¶ã€‚", "âš¡");
        Game.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    /**
     * èª¿æ•´ç©å®¶æ ¸å¿ƒæ•¸å€¼ã€‚
     * @param {string} stat - æ•¸å€¼åç¨± (gold, hp, atk)
     * @param {number} value - ç›®æ¨™æ•¸å€¼
     */
    setStat(stat, value) {
        if (!this.isEnabled) return console.error("GM TOOL: è«‹å…ˆä½¿ç”¨ GM.toggle(true) å•Ÿç”¨å·¥å…·ã€‚");
        if (value < 0) value = 0;

        switch(stat.toLowerCase()) {
            case 'gold': 
                Player.gold = value; 
                Game.log(`[GM] é‡‘å¹£è¨­å®šç‚º ${value}.`);
                break;
            case 'hp':
                Player.maxHp = value;
                Player.hp = value;
                Game.log(`[GM] ç”Ÿå‘½è¨­å®šç‚º ${value}.`);
                break;
            case 'atk':
                Player.baseAtk = value;
                Game.log(`[GM] åŸºç¤æ”»æ“Šè¨­å®šç‚º ${value}.`);
                break;
            default:
                return console.error("GM TOOL: ç„¡æ•ˆçš„æ•¸å€¼åç¨±ã€‚è«‹ä½¿ç”¨ 'gold', 'hp', æˆ– 'atk'.");
        }
        Game.recalcStats(); // é‡æ–°è¨ˆç®—æ‰€æœ‰æ•¸å€¼
        Game.updateUI();
    },

    // å¿«æ·æ–¹å¼ï¼šç²å–æ‰€æœ‰ç¥è©±/æ¥µå‚³èªªè£å‚™
    getAllTopGear() {
        if (!this.isEnabled) return console.error("GM TOOL: è«‹å…ˆä½¿ç”¨ GM.toggle(true) å•Ÿç”¨å·¥å…·ã€‚");
        
        const topRarities = ['ultra', 'mythic'];
        const itemsToGive = CONFIG.itemPool.filter(i => 
            topRarities.includes(i.rarity) && ['weapon', 'armor', 'shield'].includes(i.type)
        );

        itemsToGive.forEach(item => {
            Game.addItemToInventory(item, false);
        });

        Game.updateUI();
        Game.log(`[GM] å·²ç²å¾—æ‰€æœ‰é ‚ç´šè£å‚™ã€‚`);
        Game.showFloatingText("å…¨é ‚ç´šè£å‚™åˆ°æ‰‹!", "#ff0055");
    }
};
// ==========================================
// ã€æ–°å¢çµæŸã€‘
// ==========================================

window.GM = GM; // å°‡ GM ç‰©ä»¶ä¹Ÿæ›è¼‰åˆ°å…¨åŸŸ
window.Game = Game;
Game.init();
})();
</script>
</body>
</html>